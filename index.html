<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á´∂È¶¨„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ - GI„Éâ„É™„Éº„É†</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #1a2e1a;
            color: #fff;
        }
        .grass-pattern {
            background-color: #2d5a27;
            background-image: linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
        }
        .ticket-pattern {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 4px 4px;
        }
        .stamp-hit {
            border: 4px solid #ef4444;
            color: #ef4444;
            transform: rotate(-12deg);
        }
        .stamp-miss {
            border: 4px solid #6b7280;
            color: #6b7280;
            transform: rotate(12deg);
        }
        @keyframes gallop {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-1px) rotate(-1deg); }
            50% { transform: translateY(-2px) rotate(0deg); }
            75% { transform: translateY(-1px) rotate(1deg); }
        }
        .horse-gallop {
            animation: gallop 0.6s infinite; 
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-blink {
            animation: blink 1s infinite;
        }
        /* Custom Scrollbar for history */
        .history-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .history-scroll::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        .history-scroll::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Icons ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Coins = (p) => <IconBase {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Ticket = (p) => <IconBase {...p}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconBase>;

        // --- Constants & Data ---
        const RACE_TOTAL_DISTANCE = 2142; 

        const HORSE_NAMES_PREFIX = [
            "„Éñ„É©„ÉÉ„ÇØ", "„Çµ„Ç§„É¨„É≥„Çπ", "„Éá„Ç£„Éº„Éó", "„Çπ„Éö„Ç∑„É£„É´", "„Ç¥„Éº„É´„Éâ", "„É°„Ç∏„É≠", 
            "„Éà„Ç¶„Ç´„Ç§", "„Éä„É™„Çø", "„Ç™„Ç∞„É™", "„Éü„Çπ„Çø„Éº", "„Ç≠„É≥„Ç∞", "„Çµ„ÇØ„É©", "„ÉÄ„Ç§„ÉØ", "„Ç¶„Ç™„ÉÉ„Ç´",
            "„Ç∑„É≥„Éú„É™", "„Ç®„Ç¢", "„Ç¢„Ç∞„Éç„Çπ", "„Éû„É≥„Éè„ÉÉ„Çø„É≥", "„Éï„Ç∏", "„Ç∞„É©„Çπ", "„Ç®„É´", "„Éû„É§„Éé", "„Éì„ÉØ", "„É©„Ç§„Çπ"
        ];
        const HORSE_NAMES_SUFFIX = [
            "„Ç§„É≥„Éë„ÇØ„Éà", "„Çπ„Ç∫„Ç´", "„Ç¶„Ç£„Éº„ÇØ", "„Ç∑„ÉÉ„Éó", "„Éû„ÉÉ„ÇØ„Ç§„Éº„É≥", 
            "„ÉÜ„Ç§„Ç™„Éº", "„Éñ„É©„Ç§„Ç¢„É≥", "„Ç≠„É£„ÉÉ„Éó", "„Ç∑„Éº„Éì„Éº", "„Éò„Ç§„É≠„Éº", "„Éê„ÇØ„Ç∑„É≥", "„Çπ„Ç´„Éº„É¨„ÉÉ„Éà",
            "„É´„Éâ„É´„Éï", "„Ç∞„É´„Éº„É¥", "„Éá„Ç∏„Çø„É´", "„Ç´„Éï„Çß", "„Ç≠„Çª„Ç≠", "„ÉØ„É≥„ÉÄ„Éº", "„Ç≥„É≥„Éâ„É´", "„Éà„ÉÉ„Éó„Ç¨„É≥"
        ];
        
        // Jockeys with skill weight (0-10) and Rank display
        const JOCKEYS = [
            { name: "Ê≠¶ Ë±ä", weight: 10, rank: "S" }, { name: "„É´„É°„Éº„É´", weight: 10, rank: "S" }, 
            { name: "Â∑ùÁî∞", weight: 9, rank: "A" }, { name: "„Éá„É†„Éº„É≠", weight: 9, rank: "A" },
            { name: "Ê®™Â±±", weight: 8, rank: "A" }, { name: "Êà∏Â¥é", weight: 8, rank: "A" }, 
            { name: "Á¶èÊ∞∏", weight: 8, rank: "A" }, { name: "Ê±†Ê∑ª", weight: 8, rank: "A" }, 
            { name: "Â≤©Áî∞", weight: 7, rank: "B" }, { name: "ÊùæÂ±±", weight: 7, rank: "B" }, 
            { name: "ÂùÇ‰∫ï", weight: 7, rank: "B" }, { name: "ÂíåÁî∞", weight: 6, rank: "C" }, 
            { name: "Êµú‰∏≠", weight: 6, rank: "C" }, { name: "‰∏âÊµ¶", weight: 5, rank: "C" },
            { name: "Âπ∏", weight: 5, rank: "C" }, { name: "Ëó§Áî∞", weight: 4, rank: "D" },
            { name: "Êñ∞‰∫∫", weight: 3, rank: "D" }
        ];

        const RUNNING_STYLES = [
            { id: 0, name: "ÈÄÉ„Åí", label: "ÈÄÉ", desc: "Â∫èÁõ§„Åã„ÇâÂÖàÈ†≠„Å´Á´ã„Å§" },
            { id: 1, name: "ÂÖàË°å", label: "ÂÖà", desc: "Â•Ω‰Ωç„Å´„Å§„Åë„Å¶Êäú„ÅëÂá∫„Åô" },
            { id: 2, name: "Â∑Æ„Åó", label: "Â∑Æ", desc: "‰∏≠Âõ£„Åã„ÇâÊú´ËÑö„Çí‰º∏„Å∞„Åô" },
            { id: 3, name: "ËøΩËæº", label: "ËøΩ", desc: "ÂæåÊñπ„Åã„Çâ‰∏ÄÊ∞ó„Å´„Åî„Åº„ÅÜÊäú„Åç" },
        ];

        const BET_TYPES = {
            WIN: { id: 'WIN', name: 'ÂçòÂãù', count: 1, desc: '1ÁùÄ„Å´„Å™„ÇãÈ¶¨„ÇíÂΩì„Å¶„Åæ„Åô' },
            PLACE: { id: 'PLACE', name: 'Ë§áÂãù', count: 1, desc: '3ÁùÄ‰ª•ÂÜÖ„Å´ÂÖ•„ÇãÈ¶¨„ÇíÂΩì„Å¶„Åæ„Åô' },
            QUINELLA: { id: 'QUINELLA', name: 'È¶¨ÈÄ£', count: 2, desc: '1ÁùÄ„Å®2ÁùÄ„Å´„Å™„ÇãÈ¶¨„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂΩì„Å¶„Åæ„ÅôÔºàÈ†Ü‰∏çÂêåÔºâ' },
            WIDE: { id: 'WIDE', name: '„ÉØ„Ç§„Éâ', count: 2, desc: '3ÁùÄ‰ª•ÂÜÖ„Å´ÂÖ•„ÇãÈ¶¨„ÅÆ„ÅÜ„Å°„ÄÅ2È†≠„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂΩì„Å¶„Åæ„ÅôÔºàÈ†Ü‰∏çÂêåÔºâ' },
            EXACTA: { id: 'EXACTA', name: 'È¶¨Âçò', count: 2, desc: '1ÁùÄ„Å®2ÁùÄ„Å´„Å™„ÇãÈ¶¨„Çí„ÄÅÁùÄÈ†ÜÈÄö„Çä„Å´ÂΩì„Å¶„Åæ„Åô' },
            TRIO: { id: 'TRIO', name: '3ÈÄ£Ë§á', count: 3, desc: '1ÁùÄ„ÄÅ2ÁùÄ„ÄÅ3ÁùÄ„Å´„Å™„ÇãÈ¶¨„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂΩì„Å¶„Åæ„ÅôÔºàÈ†Ü‰∏çÂêåÔºâ' },
            TRIFECTA: { id: 'TRIFECTA', name: '3ÈÄ£Âçò', count: 3, desc: '1ÁùÄ„ÄÅ2ÁùÄ„ÄÅ3ÁùÄ„Å´„Å™„ÇãÈ¶¨„Çí„ÄÅÁùÄÈ†ÜÈÄö„Çä„Å´ÂΩì„Å¶„Åæ„Åô' },
        };

        const TIPSTER_COURSES = {
            SOLID: { id: 'SOLID', name: 'Â†ÖÂÆü„Ç≥„Éº„Çπ', desc: 'ÁöÑ‰∏≠ÁéáÈáçË¶ñÔºÅ„Ç≥„ÉÑ„Ç≥„ÉÑÁ®º„Åé„Åü„ÅÑ„ÅÇ„Å™„Åü„Å´„ÄÇ', type: 'PLACE' },
            BALANCE: { id: 'BALANCE', name: '„Éê„É©„É≥„Çπ„Ç≥„Éº„Çπ', desc: 'ÂõûÂèéÁéáÈáçË¶ñ„ÄÇÈ¶¨ÈÄ£„Åß„Åó„Å£„Åã„ÇäÂà©Áõä„ÇíÔºÅ', type: 'QUINELLA' },
            DREAM: { id: 'DREAM', name: '‰∏ÄÊî´ÂçÉÈáë„Ç≥„Éº„Çπ', desc: 'Â§¢„ÅÆ‰∏áÈ¶¨Âà∏ÔºÅÁ©¥È¶¨„ÇíÁµ°„ÇÅ„Åü3ÈÄ£ÂçòÂãùË≤†ÔºÅ', type: 'TRIFECTA' },
        };

        const generateHorseName = () => {
            const pre = HORSE_NAMES_PREFIX[Math.floor(Math.random() * HORSE_NAMES_PREFIX.length)];
            const suf = HORSE_NAMES_SUFFIX[Math.floor(Math.random() * HORSE_NAMES_SUFFIX.length)];
            return pre + suf;
        };

        // --- Helper Functions ---

        const calculateComboOdds = (type, horseIndices, horses) => {
            if (!horseIndices.every(idx => idx !== null && idx !== undefined)) return 0;
            const probs = horseIndices.map(idx => 1 / horses[idx].odds); 
            let jointProb = 1;
            
            if (type === BET_TYPES.WIN.id) {
                jointProb = probs[0];
            } else if (type === BET_TYPES.PLACE.id) {
                // Place is roughly 3x Win probability
                jointProb = probs[0] * 3.0;
            } else if (type === BET_TYPES.QUINELLA.id) {
                // Quinella (Top 2 any order)
                jointProb = probs[0] * probs[1] * 2.5; 
            } else if (type === BET_TYPES.WIDE.id) {
                // Wide (Top 3 any 2) - Easiest of combo bets
                jointProb = probs[0] * probs[1] * 4.5; 
            } else if (type === BET_TYPES.EXACTA.id) {
                // Exacta (Top 2 exact order) - Harder than Quinella
                jointProb = probs[0] * probs[1] * 1.2;
            } else if (type === BET_TYPES.TRIO.id) {
                jointProb = probs[0] * probs[1] * probs[2] * 7.0; 
            } else if (type === BET_TYPES.TRIFECTA.id) {
                jointProb = probs[0] * probs[1] * probs[2] * 1.5; 
            }

            let odds = (1 / jointProb) * 0.75; 
            if (type !== BET_TYPES.WIN.id && odds < 1.1) odds = 1.1;
            if (type === BET_TYPES.PLACE.id && odds < 1.0) odds = 1.0; 
            
            return Math.min(99999.9, Math.max(1.0, parseFloat(odds.toFixed(1))));
        };
        
        const checkWin = (bet, finishOrder) => {
            if (!finishOrder || finishOrder.length < 3) return false;
            
            const ids = bet.selection.map(h => h.id);
            const r1 = finishOrder[0].id;
            const r2 = finishOrder[1].id;
            const r3 = finishOrder[2].id;

            if (bet.type === 'WIN') {
                return ids[0] === r1;
            } else if (bet.type === 'PLACE') {
                return ids[0] === r1 || ids[0] === r2 || ids[0] === r3;
            } else if (bet.type === 'QUINELLA') {
                const top2 = [r1, r2];
                return top2.includes(ids[0]) && top2.includes(ids[1]);
            } else if (bet.type === 'WIDE') {
                const top3 = [r1, r2, r3];
                return top3.includes(ids[0]) && top3.includes(ids[1]);
            } else if (bet.type === 'EXACTA') {
                return ids[0] === r1 && ids[1] === r2;
            } else if (bet.type === 'TRIO') {
                const top3 = [r1, r2, r3].sort().join(',');
                const sel = [...ids].sort().join(',');
                return top3 === sel;
            } else if (bet.type === 'TRIFECTA') {
                return ids[0] === r1 && ids[1] === r2 && ids[2] === r3;
            }
            return false;
        };

        // --- Extracted Tipster Modal Component ---
        const TipsterModal = ({ isOpen, onClose, onPurchase, wallet, budget, setBudget, course, setCourse }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200">
                        <div className="bg-purple-600 text-white p-4 flex justify-between items-center">
                            <h3 className="text-lg font-bold flex items-center gap-2"><Sparkles /> ‰∫àÊÉ≥Â±ã„ÅÆÈÉ®Â±ã</h3>
                            <button onClick={onClose} className="text-2xl hover:text-gray-300">&times;</button>
                        </div>
                        <div className="p-6">
                            <p className="text-gray-600 mb-4 text-sm font-bold">
                                „Äå„Çè„Åó„ÅØ‰∫àÊÉ≥Â±ã„Åï„Çì„Åò„ÇÉ„ÄÇË™øÂ≠ê„ÅÆ„ÅÑ„ÅÑÈ¶¨Ë¶ã„Åà„Å¶„Åä„Çã„Åû„ÄÇ„Äç
                            </p>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-bold text-gray-700 mb-1">‰∫àÁÆó (ÊâÄÊåÅÈáë: {wallet.toLocaleString()}ÂÜÜ)</label>
                                <input 
                                    type="number" 
                                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 text-gray-900 bg-white placeholder-gray-500"
                                    style={{ color: 'black', backgroundColor: 'white' }}
                                    value={budget}
                                    onChange={(e) => setBudget(e.target.value)}
                                    step="100"
                                />
                            </div>

                            <div className="space-y-3 mb-6">
                                {Object.values(TIPSTER_COURSES).map(c => (
                                    <div 
                                        key={c.id}
                                        onClick={() => setCourse(c.id)}
                                        className={`p-3 border rounded-lg cursor-pointer transition-all ${course === c.id ? 'border-purple-500 bg-purple-50 shadow-md' : 'border-gray-200 hover:bg-gray-50'}`}
                                    >
                                        <div className="font-bold text-purple-700">{c.name}</div>
                                        <div className="text-xs text-gray-500">{c.desc}</div>
                                    </div>
                                ))}
                            </div>

                            <button 
                                onClick={onPurchase}
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition active:scale-95"
                            >
                                ‰∫àÊÉ≥„ÇíË≥ºÂÖ•„Åô„Çã
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---

        const App = () => {
            // Load initial state from localStorage or default
            const [wallet, setWallet] = useState(() => {
                const saved = localStorage.getItem('g1dream_wallet');
                return saved !== null ? parseInt(saved) : 100000;
            });
            const [raceCount, setRaceCount] = useState(() => {
                const saved = localStorage.getItem('g1dream_raceCount');
                return saved !== null ? parseInt(saved) : 1;
            });
            const [resultLog, setResultLog] = useState(() => {
                const saved = localStorage.getItem('g1dream_resultLog');
                return saved !== null ? JSON.parse(saved) : [];
            });

            const [phase, setPhase] = useState('betting'); 
            const [horses, setHorses] = useState([]);
            
            // Betting State
            const [betType, setBetType] = useState(BET_TYPES.WIN.id);
            const [selectedHorses, setSelectedHorses] = useState([null, null, null]); 
            const [betAmount, setBetAmount] = useState(1000); 
            const [betSlip, setBetSlip] = useState([]); 
            
            // Race State
            const [raceProgress, setRaceProgress] = useState([]); 
            const [raceTime, setRaceTime] = useState(0);
            const [raceRanking, setRaceRanking] = useState([]); 
            const [finalResult, setFinalResult] = useState(null);
            const [commentary, setCommentary] = useState("„Éë„Éâ„ÉÉ„ÇØÂë®Âõû‰∏≠...");
            
            const [showHistory, setShowHistory] = useState(false); 
            
            // Tooltip State
            const [hoveredHorse, setHoveredHorse] = useState(null);

            // Tipster State
            const [showTipster, setShowTipster] = useState(false);
            const [tipsterBudget, setTipsterBudget] = useState(1000);
            const [tipsterCourse, setTipsterCourse] = useState('SOLID');

            const animationRef = useRef(null);

            // Save to localStorage whenever state changes
            useEffect(() => {
                localStorage.setItem('g1dream_wallet', wallet);
                localStorage.setItem('g1dream_raceCount', raceCount);
                localStorage.setItem('g1dream_resultLog', JSON.stringify(resultLog));
            }, [wallet, raceCount, resultLog]);

            // Reset Function
            const resetGame = () => {
                if (confirm("„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Å¶ÊúÄÂàù„Åã„ÇâÈÅä„Å≥„Åæ„Åô„ÅãÔºü\nÔºàÊâÄÊåÅÈáë„ÄÅÊà¶Á∏æ„Åå„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„ÅôÔºâ")) {
                    localStorage.removeItem('g1dream_wallet');
                    localStorage.removeItem('g1dream_raceCount');
                    localStorage.removeItem('g1dream_resultLog');
                    window.location.reload();
                }
            };

            // Unified Bet Type Change Handler
            const handleBetTypeChange = (newType) => {
                setBetType(newType);
                setSelectedHorses([null, null, null]);
            };

            // --- Game Logic ---

            const setupRace = () => {
                const numHorses = 8; 
                const newHorses = [];
                let totalPopularityScore = 0;

                const usedNames = new Set();
                const usedJockeys = new Set(); 
                let strengthPool = [];
                
                // 1. Generate Capability
                const racePattern = Math.random();
                let patternName = "";

                if (racePattern < 0.3) {
                    patternName = "1Âº∑";
                    strengthPool.push(95 + Math.random() * 10); 
                    for(let k=0; k<7; k++) strengthPool.push(40 + Math.random() * 35); 
                } else if (racePattern < 0.6) {
                    patternName = "2Âº∑";
                    strengthPool.push(90 + Math.random() * 8);
                    strengthPool.push(90 + Math.random() * 8);
                    for(let k=0; k<6; k++) strengthPool.push(40 + Math.random() * 35);
                } else if (racePattern < 0.8) {
                    patternName = "3Âº∑";
                    for(let k=0; k<3; k++) strengthPool.push(85 + Math.random() * 10);
                    for(let k=0; k<5; k++) strengthPool.push(40 + Math.random() * 35);
                } else {
                    patternName = "Ê∑∑Êà¶";
                    const baseStrength = 60 + Math.random() * 10;
                    for(let k=0; k<8; k++) strengthPool.push(baseStrength + (Math.random() - 0.5) * 20); 
                }
                strengthPool.sort(() => Math.random() - 0.5);

                for (let i = 0; i < numHorses; i++) {
                    const strength = Math.max(20, Math.min(120, strengthPool[i]));

                    // Name
                    let name = generateHorseName();
                    let attempts = 0;
                    while(usedNames.has(name) && attempts < 20) { name = generateHorseName(); attempts++; }
                    usedNames.add(name);

                    // Jockey
                    let jockey = JOCKEYS[Math.floor(Math.random() * JOCKEYS.length)];
                    attempts = 0;
                    while(usedJockeys.has(jockey.name) && attempts < 50) {
                        jockey = JOCKEYS[Math.floor(Math.random() * JOCKEYS.length)];
                        attempts++;
                    }
                    usedJockeys.add(jockey.name);

                    // Condition
                    const condition = (Math.random() * 0.6) - 0.3;

                    // Past Result
                    const perfBase = 120 - strength + (Math.random() * 30 - 15); 
                    let prevRank = 1;
                    if (perfBase < 30) prevRank = 1;
                    else if (perfBase < 40) prevRank = 2;
                    else if (perfBase < 50) prevRank = 3;
                    else if (perfBase < 60) prevRank = 4;
                    else if (perfBase < 80) prevRank = Math.floor(Math.random()*2)+5; 
                    else prevRank = Math.floor(Math.random()*2)+7; 
                    if(prevRank > 8) prevRank = 8;

                    // Weight
                    const baseWeight = 460 + Math.floor(Math.random() * 80);
                    const weightDiff = Math.floor(Math.random() * 16) - 8; 
                    const currentWeight = baseWeight + weightDiff;

                    newHorses.push({
                        id: i,
                        number: i + 1,
                        name: name,
                        jockey: jockey.name,
                        jockeyWeight: jockey.weight, 
                        jockeyRank: jockey.rank,
                        strength: strength,
                        stamina: Math.random() * 0.4 + 0.8,
                        style: RUNNING_STYLES[Math.floor(Math.random() * RUNNING_STYLES.length)],
                        condition: condition,
                        prevRank: prevRank,
                        weight: currentWeight,
                        weightDiff: weightDiff,
                        odds: 0 
                    });
                }

                // 2. Calculate Odds
                newHorses.forEach(h => {
                    let rankScore = 0;
                    if (h.prevRank === 1) rankScore = 100;
                    else if (h.prevRank === 2) rankScore = 80;
                    else if (h.prevRank === 3) rankScore = 60;
                    else if (h.prevRank <= 5) rankScore = 40;
                    else rankScore = 20;

                    const jockeyScore = h.jockeyWeight * 3; 
                    const hype = (h.strength * 0.4) + (h.condition * 20) + (Math.random() * 10);

                    h.popularity = rankScore + jockeyScore + hype;
                    h.popularity = Math.pow(h.popularity, 2.5); 
                    
                    totalPopularityScore += h.popularity;
                });

                newHorses.forEach(horse => {
                    const prob = horse.popularity / totalPopularityScore;
                    let rawOdds = (1 / prob) * 0.8; 
                    if (rawOdds < 1.1) rawOdds = 1.1;
                    if (rawOdds > 300.0) rawOdds = 300.0 + (Math.random() * 200); 
                    horse.odds = parseFloat(rawOdds.toFixed(1));
                });

                setHorses(newHorses);
                setBetSlip([]);
                setRaceProgress(newHorses.map(h => ({ id: h.id, dist: 0, speed: 0, lane: h.id, rank: null, status: 'normal' })));
                setFinalResult(null);
                setPhase('betting');
                setCommentary(`Á¨¨${raceCount}„É¨„Éº„Çπ (${patternName})„ÄÅÊäïÁ•®Âèó‰ªò‰∏≠ÔºÅ`);
                setSelectedHorses([null, null, null]);
            };

            useEffect(() => setupRace(), []);

            // --- Tipster Functionality (Added) ---

            const purchaseTipsterPrediction = () => {
                if (tipsterBudget > wallet && wallet >= 100) {
                    alert("ÊâÄÊåÅÈáë„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅÂÄüÈáë„Çí„Åó„Å¶Ë≥ºÂÖ•„Åó„Åæ„Åô„ÅãÔºü");
                } else if (tipsterBudget <= 0) {
                    alert("‰∫àÁÆó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    return;
                }

                // Calculate Tipster Scores
                // Formula: (strength * 0.4) + (condition * 50) + (jockeyWeight * 2)
                const scoredHorses = horses.map(h => ({
                    ...h,
                    tipsterScore: (h.strength * 0.4) + (h.condition * 50) + (h.jockeyWeight * 2)
                })).sort((a, b) => b.tipsterScore - a.tipsterScore);

                let betTypeToUse = '';
                let selection = [];

                if (tipsterCourse === 'SOLID') {
                    // Solid: Place (Best horse)
                    betTypeToUse = 'PLACE';
                    selection = [scoredHorses[0]];
                } else if (tipsterCourse === 'BALANCE') {
                    // Balance: Quinella (Top 2)
                    betTypeToUse = 'QUINELLA';
                    selection = [scoredHorses[0], scoredHorses[1]];
                } else if (tipsterCourse === 'DREAM') {
                    // Dream: Trifecta (Top 2 + Dark Horse)
                    const darkHorses = horses.filter(h => h.odds >= 10.0).sort((a, b) => b.condition - a.condition);
                    const darkHorse = darkHorses.length > 0 ? darkHorses[0] : scoredHorses[2];
                    
                    // Avoid duplicates
                    const picks = [scoredHorses[0], scoredHorses[1]];
                    if (picks.some(p => p.id === darkHorse.id)) {
                         selection = [scoredHorses[0], scoredHorses[1], scoredHorses[2]];
                    } else {
                         selection = [scoredHorses[0], scoredHorses[1], darkHorse];
                    }
                    betTypeToUse = 'TRIFECTA';
                }

                // Calculate Odds
                const odds = calculateComboOdds(betTypeToUse, selection.map(s => s.id), horses);

                const newBet = {
                    id: Date.now(),
                    type: betTypeToUse,
                    typeName: BET_TYPES[betTypeToUse].name,
                    selection: selection,
                    amount: parseInt(tipsterBudget),
                    odds: odds,
                    isTipster: true // Mark as tipster bet
                };

                setBetSlip(prev => [...prev, newBet]);
                setShowTipster(false);
                alert("‰∫àÊÉ≥„ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅÊäïÁ•®„É™„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            };

            // --- Betting Handlers ---

            const addToSlip = () => {
                const required = BET_TYPES[betType].count;
                const selection = selectedHorses.slice(0, required);
                
                if (selection.includes(null)) {
                    alert("È¶¨„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    return;
                }
                const uniqueSelection = new Set(selection);
                if (uniqueSelection.size !== selection.length) {
                    alert("Âêå„ÅòÈ¶¨„ÇíÈáçË§á„Åó„Å¶ÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„Çì");
                    return;
                }
                if (betAmount <= 0) return;

                const currentOdds = calculateComboOdds(betType, selection.map(i => horses[i].id), horses);

                const newBet = {
                    id: Date.now(),
                    type: betType,
                    typeName: BET_TYPES[betType].name,
                    selection: selection.map(idx => horses[idx]), 
                    amount: parseInt(betAmount),
                    odds: currentOdds,
                    isTipster: false
                };

                setBetSlip([...betSlip, newBet]);
            };

            const removeBet = (id) => {
                setBetSlip(betSlip.filter(b => b.id !== id));
            };

            const getTotalBetAmount = () => betSlip.reduce((sum, b) => sum + b.amount, 0);

            const startRace = () => {
                const total = getTotalBetAmount();
                if (total === 0) {
                    if(!confirm("Ë≥≠„ÅëÈáë„Å™„Åó„ÅßË¶≥Êà¶„Åó„Åæ„Åô„ÅãÔºü")) return;
                }
                
                if (total > wallet) {
                    if (!confirm(`Ë≥áÈáë„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ\nÊÆãÈ´ò: ${wallet.toLocaleString()}ÂÜÜ\nË≥≠„ÅëÈáë: ${total.toLocaleString()}ÂÜÜ\n\nÂÄüÈáë„Åó„Å¶Ë≥≠„Åë„Åæ„Åô„ÅãÔºü`)) {
                        return;
                    }
                }

                setWallet(prev => prev - total);
                setPhase('fanfare'); 
                setCommentary("„Åæ„ÇÇ„Å™„ÅèÁô∫Ëµ∞„Åß„Åô...");
                
                setTimeout(() => setCommentary("„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨„ÅåÈ≥¥„ÇäÈüø„Åç„Åæ„ÅôÔºÅ"), 300);
                setTimeout(() => setCommentary("ÂêÑÈ¶¨„Ç≤„Éº„Éà„Ç§„É≥ÂÆå‰∫Ü..."), 1800);
                setTimeout(() => {
                    setPhase('racing');
                    setCommentary("„Çπ„Çø„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ");
                    runRace();
                }, 2500);
            };

            // --- Race Simulation ---

            const runRace = () => {
                let currentProgress = horses.map(h => ({ 
                    id: h.id, 
                    dist: 0, 
                    speed: 0,
                    fatigue: 0,
                    rank: null,
                    status: 'normal', 
                    maxSpeed: (h.strength / 100) + 0.8 
                }));
                
                const TOTAL_DISTANCE = RACE_TOTAL_DISTANCE; 
                let time = 0;
                let nextRank = 1;
                let finishedOrder = [];

                currentProgress = currentProgress.map(p => {
                    const horse = horses.find(h => h.id === p.id);
                    const lateStartChance = (10 - horse.jockeyWeight) * 0.01;
                    if (Math.random() < lateStartChance) {
                        p.status = 'late_start';
                    }
                    return p;
                });

                setRaceProgress(currentProgress); 

                const loop = () => {
                    time += 0.1; 
                    let anyoneFinished = false;

                    currentProgress = currentProgress.map(p => {
                        if (p.rank !== null) return p;

                        const horse = horses.find(h => h.id === p.id);
                        const progressPct = p.dist / TOTAL_DISTANCE;

                        let targetSpeed = p.maxSpeed;
                        const randomFactor = (Math.random() - 0.5) * 0.3; 

                        let conditionMod = horse.condition * 0.3;
                        if (horse.weightDiff > 0) {
                            conditionMod -= horse.weightDiff * 0.005; 
                        }
                        targetSpeed *= (1 + conditionMod);

                        const fatigueRate = 0.02 * (1.0 - (horse.jockeyWeight * 0.02));

                        if (p.status === 'late_start') {
                            targetSpeed *= 0.5; 
                            if (progressPct > 0.05) p.status = 'normal'; 
                        }

                        if (progressPct > 0.2 && progressPct < 0.7 && p.status === 'normal') {
                            const kakariChance = (10 - horse.jockeyWeight) * 0.0005; 
                            if (Math.random() < kakariChance) {
                                p.status = 'kakari';
                            }
                        }
                        
                        if (p.status === 'kakari') {
                            targetSpeed *= 1.15; 
                            p.fatigue += (p.speed * fatigueRate * 3);
                            if (Math.random() < 0.03) p.status = 'normal';
                        } else {
                            p.fatigue += (p.speed * fatigueRate);
                        }

                        if (progressPct < 0.15) { 
                            if (horse.style.id === 0) targetSpeed *= 1.2; 
                            else if (horse.style.id === 3) targetSpeed *= 0.8; 
                        } else if (progressPct < 0.6) { 
                            if (horse.style.id === 0) targetSpeed *= 0.95; 
                            else if (horse.style.id === 3) targetSpeed *= 0.9; 
                            else targetSpeed *= 0.9; 
                            if (Math.random() < 0.01) targetSpeed *= 1.2; 
                        } else if (progressPct < 0.85) { 
                             if (horse.style.id === 1) targetSpeed *= 1.1; 
                             if (horse.style.id === 2) targetSpeed *= 1.2; 
                        } else { 
                             if (horse.style.id === 3) targetSpeed *= 1.5; 
                             else if (horse.style.id === 0) targetSpeed *= 0.8; 
                             else targetSpeed *= 1.0; 
                             
                             if (p.fatigue > horse.strength * horse.stamina * (0.6 + Math.random())) {
                                 targetSpeed *= 0.5; 
                             }
                        }

                        const accel = (targetSpeed - p.speed) * 0.02; 
                        p.speed += accel + randomFactor;
                        
                        if(p.speed < 0.2) p.speed = 0.2; 
                        p.dist += p.speed;
                        
                        if (p.dist >= TOTAL_DISTANCE) {
                            p.dist = TOTAL_DISTANCE; 
                            p.rank = nextRank; 
                            nextRank++;
                            finishedOrder.push(horse);
                            anyoneFinished = true;
                        }

                        return p;
                    });

                    const sorted = [...currentProgress].sort((a, b) => {
                        if (a.rank !== null && b.rank !== null) return a.rank - b.rank;
                        if (a.rank !== null) return -1;
                        if (b.rank !== null) return 1;
                        return b.dist - a.dist;
                    });
                    
                    setRaceRanking(sorted.map(p => {
                        const h = horses.find(h => h.id === p.id);
                        return { ...h, rank: p.rank };
                    }));
                    setRaceProgress([...currentProgress]);
                    setRaceTime(time);

                    if (Math.floor(time * 10) % 200 === 0 && phase === 'racing') { 
                        const leader = sorted[0];
                        const leaderHorse = horses.find(h => h.id === leader.id);
                        const pct = leader.dist / TOTAL_DISTANCE;
                        
                        const badStartHorse = currentProgress.find(p => p.status === 'late_start');
                        const kakariHorse = currentProgress.find(p => p.status === 'kakari');

                        if (pct < 0.1) {
                            if (badStartHorse) {
                                const h = horses.find(x => x.id === badStartHorse.id);
                                setCommentary(`„Åä„Å£„Å®ÔºÅ${h.name}„ÄÅÂá∫ÈÅÖ„Çå„Å¶„Åó„Åæ„Å£„ÅüÔºÅ`);
                            } else {
                                setCommentary(`ÂêÑÈ¶¨„ÄÅ„Åç„Çå„ÅÑ„Å™„Çπ„Çø„Éº„Éà„ÇíÂàá„Çä„Åæ„Åó„Åü„ÄÇ`);
                            }
                        } else if (pct < 0.5) {
                            if (kakariHorse) {
                                const h = horses.find(x => x.id === kakariHorse.id);
                                setCommentary(`${h.name}„ÄÅÂ∞ë„ÅóÊéõ„Åã„Å£„Å¶„ÅÑ„Çã„ÅãÔºüÊäë„Åà„Åç„Çå„Å™„ÅÑÊßòÂ≠êÔºÅ`);
                            } else {
                                setCommentary(`${leaderHorse.name}„Åå„É¨„Éº„Çπ„ÇíÂºï„Å£Âºµ„ÇãÔºÅ`);
                            }
                        } else if (pct < 0.85) {
                            setCommentary(`4„Ç≥„Éº„Éä„Éº„ÇíÂõû„ÇãÔºÅÁõ¥Á∑öÂãùË≤†„Å†ÔºÅ`);
                        } else if (pct < 0.95) {
                            setCommentary(`${leaderHorse.name}„ÅåÊäú„ÅëÂá∫„Åó„ÅüÔºÅ`);
                        } else {
                            if (!finalResult) setCommentary(`„Ç¥„Éº„É´„Åæ„Åß„ÅÇ„Å®Â∞ë„ÅóÔºÅ`);
                        }
                    }

                    if (nextRank > horses.length) {
                        setFinalResult(finishedOrder);
                        setPhase('result');
                        processResults(finishedOrder);
                        cancelAnimationFrame(animationRef.current);
                    } else {
                        animationRef.current = requestAnimationFrame(loop);
                    }
                };
                animationRef.current = requestAnimationFrame(loop);
            };

            const processResults = (order) => {
                setCommentary(`1ÁùÄ ${order[0].name}ÔºÅ „Ç¥„Éº„É´„Ç§„É≥ÔºÅ`);
                let totalPayout = 0;

                betSlip.forEach(bet => {
                    if (checkWin(bet, order)) {
                        totalPayout += Math.floor(bet.amount * bet.odds);
                    }
                });

                setWallet(prev => prev + totalPayout);
                setResultLog(prev => [{
                    race: raceCount,
                    winner: order[0].name,
                    betTotal: getTotalBetAmount(),
                    payout: totalPayout
                }, ...prev]);
            };

            const nextRace = () => {
                setRaceCount(p => p + 1);
                setupRace();
            };

            // --- Components ---
            
            const FanfareView = () => (
                <div className="flex flex-col items-center justify-center h-64 bg-black/80 rounded-xl border-4 border-yellow-500 animate-in fade-in zoom-in duration-500">
                    <div className="text-yellow-400 text-6xl mb-4 animate-bounce">üé∫</div>
                    <h2 className="text-4xl font-black text-white tracking-widest animate-pulse">G1 FANFARE</h2>
                    <p className="text-gray-300 mt-4 text-sm">„Åæ„ÇÇ„Å™„Åè„Ç≤„Éº„Éà„ÅåÈñã„Åç„Åæ„Åô...</p>
                </div>
            );

            const RaceTrack = ({ horses, progress }) => {
                const getPos = (totalDistRun, laneIdx) => {
                    const trackL = 600;
                    const trackR = 150;
                    const perimeter = trackL * 2 + Math.PI * trackR * 2; 
                    const GOAL_D_POS = 600; 
                    
                    const distMod = RACE_TOTAL_DISTANCE % perimeter;
                    let startOffset = GOAL_D_POS - distMod;
                    if (startOffset < 0) startOffset += perimeter;
                    
                    let d = (totalDistRun + startOffset) % perimeter;

                    const laneOffset = (laneIdx - 3.5) * 12; 
                    const r = trackR + laneOffset;

                    let x, y;

                    if (d < 600) {
                        const p = d / 600;
                        x = 200 + (600 * p);
                        y = 50 - laneOffset;
                    }
                    else if (d < 600 + Math.PI * trackR) {
                        const arcLen = d - 600;
                        const angle = (arcLen / (Math.PI * trackR)) * Math.PI;
                        const theta = 0.5 * Math.PI - angle;
                        x = 800 + r * Math.cos(theta);
                        y = 200 - r * Math.sin(theta);
                    }
                    else if (d < 600 + Math.PI * trackR + 600) {
                        const strLen = d - (600 + Math.PI * trackR);
                        x = 800 - strLen;
                        y = 350 + laneOffset;
                    }
                    else {
                        const arcLen = d - (1200 + Math.PI * trackR);
                        const angle = (arcLen / (Math.PI * trackR)) * Math.PI;
                        const theta = 1.5 * Math.PI - angle; 
                        x = 200 + r * Math.cos(theta);
                        y = 200 - r * Math.sin(theta); 
                    }

                    return { x, y };
                };

                return (
                    <div className="relative w-full aspect-[2/1] bg-green-800 rounded-xl overflow-hidden shadow-inner border-4 border-yellow-700">
                        <div className="absolute inset-0 grass-pattern opacity-50"></div>
                        <svg className="absolute inset-0 w-full h-full" viewBox="0 0 1000 400" preserveAspectRatio="xMidYMid meet">
                            <path d="M 200 50 L 800 50 A 150 150 0 1 1 800 350 L 200 350 A 150 150 0 1 1 200 50 Z" fill="none" stroke="#eab308" strokeWidth="120" strokeOpacity="0.2" />
                            <path d="M 200 50 L 800 50 A 150 150 0 1 1 800 350 L 200 350 A 150 150 0 1 1 200 50 Z" fill="none" stroke="white" strokeWidth="2" strokeDasharray="20,20" />
                            <line x1="800" y1="10" x2="800" y2="90" stroke="white" strokeWidth="8" />
                            <text x="810" y="80" fill="white" fontSize="20" fontWeight="bold">GOAL</text>
                            <text x="810" y="40" fill="white" fontSize="16" opacity="0.7">START</text>
                        </svg>
                        {horses.map(horse => {
                            const p = progress.find(pr => pr.id === horse.id);
                            if(!p) return null;
                            const pos = getPos(p.dist, horse.id);
                            
                            let statusEffect = "";
                            if (p.status === 'late_start') statusEffect = "opacity-50"; 
                            if (p.status === 'kakari') statusEffect = "animate-pulse brightness-150"; 

                            return (
                                <div
                                    key={horse.id}
                                    className={`absolute transition-transform duration-100 will-change-transform flex justify-center items-center ${statusEffect}`}
                                    style={{
                                        left: `${pos.x / 10}%`, 
                                        top: `${pos.y / 4}%`,
                                        width: '4%', 
                                        height: '10%',
                                        transform: `translate(-50%, -50%)`,
                                        zIndex: Math.floor(p.dist)
                                    }}
                                >
                                    <div className="relative flex flex-col items-center">
                                        <div className={`text-2xl filter drop-shadow-md ${phase === 'racing' ? 'horse-gallop' : ''}`}>üê¥</div>
                                        <div 
                                            className="text-[8px] text-white px-1 rounded whitespace-nowrap -mt-1 font-bold"
                                            style={{ backgroundColor: ['white', 'black', '#e53935', '#1e88e5', '#fdd835', '#43a047', '#fb8c00', '#f48fb1'][horse.id % 8], color: horse.id % 8 ===0 || horse.id % 8 === 4 || horse.id % 8 === 7 ?'black':'white', border: horse.id===0?'1px solid #ccc':'none' }}
                                        >
                                            {horse.number}.{horse.name}
                                        </div>
                                        {p.status === 'late_start' && <div className="absolute -top-4 text-xs font-bold text-red-500 bg-white px-1 rounded">ÈÅÖ</div>}
                                        {p.status === 'kakari' && <div className="absolute -top-4 text-xs font-bold text-yellow-500 bg-black px-1 rounded">Êéõ</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            const HorseSelectionRow = ({ index, label }) => (
                <div className="flex items-center gap-2 mb-2">
                    <span className="w-16 font-bold text-gray-700 text-sm">{label}</span>
                    <select 
                        className="flex-1 p-2 bg-white border border-gray-300 rounded text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={selectedHorses[index] === null ? "" : selectedHorses[index]}
                        onChange={(e) => {
                            const val = e.target.value === "" ? null : parseInt(e.target.value);
                            const newSel = [...selectedHorses];
                            newSel[index] = val;
                            setSelectedHorses(newSel);
                        }}
                    >
                        <option value="">ÈÅ∏Êäû...</option>
                        {horses.map((h, i) => (
                            <option key={h.id} value={i} disabled={selectedHorses.includes(i) && selectedHorses[index] !== i}>
                                {h.number}. {h.name} (Âçò{h.odds}) - {h.jockey}
                            </option>
                        ))}
                    </select>
                </div>
            );

            // *** BETTING TICKET (Updated for Tipster) ***
            const BettingTicket = ({ bet, onDelete, isResult, hit, readOnly }) => (
                <div className={`bg-white border-2 ${isResult ? (hit ? 'border-red-500' : 'border-gray-400') : (bet.isTipster ? 'border-purple-600' : 'border-green-700')} rounded shadow-md relative overflow-hidden font-mono w-full mb-3 max-w-sm mx-auto transform transition ${!isResult && 'hover:scale-[1.02]'}`}>
                    <div className={`${isResult ? (hit ? 'bg-red-500' : 'bg-gray-500') : (bet.isTipster ? 'bg-purple-600' : 'bg-green-700')} text-white text-xs px-2 py-1 flex justify-between items-center`}>
                        <span className="font-bold flex items-center gap-1">
                            {bet.isTipster ? <Sparkles size={12} /> : <Ticket size={12} />}
                            {bet.isTipster ? '‰∫àÊÉ≥Â±ãÊú¨Ëàó' : 'Èò™Á•ûÁ´∂È¶¨Â†¥'}
                        </span>
                        <span>{new Date(bet.id).toLocaleTimeString()} Áô∫Âà∏</span>
                    </div>
                    
                    <div className="p-3 text-gray-800 ticket-pattern relative">
                        <div className="flex justify-between items-end border-b-2 border-dashed border-gray-300 pb-2 mb-2">
                            <div>
                                <div className="text-xs text-gray-500 font-bold mb-1">{bet.typeName}</div>
                                <div className="text-2xl font-black tracking-widest">
                                    {bet.selection.map(h => h.number).join(bet.type === 'TRIFECTA' ? ' ‚Üí ' : ' - ')}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-gray-500">„Ç™„ÉÉ„Ç∫</div>
                                <div className="text-lg font-bold text-red-600">{bet.odds}ÂÄç</div>
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-center">
                            <div className="text-sm font-bold">
                                {bet.amount.toLocaleString()}ÂÜÜ
                            </div>
                            {!isResult && !readOnly && ( // Check readOnly here
                                <button 
                                    onClick={() => onDelete(bet.id)}
                                    className="text-gray-400 hover:text-red-500 transition-colors p-1"
                                    title="Âèñ„ÇäÊ∂à„Åó"
                                >
                                    <Trash2 size={16} />
                                </button>
                            )}
                            {isResult && (
                                <div className="text-sm font-bold">
                                    {hit ? <span className="text-red-600">ÁöÑ‰∏≠ÔºÅ</span> : <span className="text-gray-400">„Éè„Ç∫„É¨</span>}
                                </div>
                            )}
                        </div>
                        
                        {isResult && hit && (
                             <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 stamp-hit border-4 font-black text-3xl px-2 select-none pointer-events-none opacity-80">
                                HIT
                            </div>
                        )}
                        {isResult && !hit && (
                             <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 stamp-miss border-4 font-black text-3xl px-2 select-none pointer-events-none opacity-40">
                                LOSE
                            </div>
                        )}
                        {!isResult && (
                             <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-4 ${bet.isTipster ? 'border-purple-500/20 text-purple-500/20' : 'border-red-500/20 text-red-500/20'} font-black text-3xl rotate-12 px-2 select-none pointer-events-none`}>
                                {bet.isTipster ? 'PRO' : 'VOTE'}
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-green-900 pb-24">
                    {/* Header */}
                    <header className="bg-gray-900 text-white p-3 sticky top-0 z-20 shadow-lg border-b-4 border-yellow-600 flex justify-between items-center">
                        <div className="flex items-center gap-2" onClick={resetGame} style={{ cursor: 'pointer' }}>
                            <Trophy className="text-yellow-400" size={24} />
                            <div>
                                <h1 className="font-bold text-lg leading-tight">G1 „Éâ„É™„Éº„É†</h1>
                                <span className="text-xs text-gray-400">RACE {raceCount}</span>
                            </div>
                        </div>
                        
                        <div 
                            className="relative group cursor-pointer"
                            onMouseEnter={() => setShowHistory(true)}
                            onMouseLeave={() => setShowHistory(false)}
                        >
                            <div className={`flex items-center gap-2 px-3 py-1 rounded-full transition-colors ${wallet < 0 ? 'bg-red-900 animate-pulse' : 'bg-gray-800'}`}>
                                <Coins className={wallet < 0 ? 'text-red-400' : 'text-yellow-400'} size={16} />
                                <span className={`font-mono font-bold text-lg ${wallet < 0 ? 'text-red-400' : ''}`}>
                                    {wallet.toLocaleString()}
                                </span>
                                {wallet < 0 && <span className="text-xs bg-red-600 px-1 rounded text-white">ÂÄüÈáë‰∏≠</span>}
                            </div>

                            {/* History Tooltip */}
                            {showHistory && (
                                <div className="absolute right-0 top-full mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-2xl p-3 z-50 animate-in fade-in zoom-in-95 duration-200">
                                    <h4 className="text-xs text-gray-400 font-bold mb-2 flex items-center gap-1">
                                        <Info size={12} /> ÂèéÊîØÂ±•Ê≠¥ (Áõ¥Ëøë10‰ª∂)
                                    </h4>
                                    <div className="max-h-60 overflow-y-auto history-scroll space-y-2">
                                        {resultLog.length === 0 ? (
                                            <div className="text-xs text-gray-600 text-center py-4">Â±•Ê≠¥„Å™„Åó</div>
                                        ) : (
                                            resultLog.slice(0, 10).map((log, idx) => {
                                                const balance = log.payout - log.betTotal;
                                                return (
                                                    <div key={idx} className="bg-gray-800 p-2 rounded text-xs border border-gray-700">
                                                        <div className="flex justify-between mb-1">
                                                            <span className="text-yellow-500">RACE {log.race}</span>
                                                            <span className="text-gray-400">{log.winner}</span>
                                                        </div>
                                                        <div className="flex justify-between items-end">
                                                            <span className="text-gray-500">¬•{log.betTotal} ‚Üí ¬•{log.payout}</span>
                                                            <span className={`font-bold ${balance >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                                {balance > 0 ? '+' : ''}{balance.toLocaleString()}
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                    <div className="mt-2 pt-2 border-t border-gray-700 text-right text-xs">
                                        <div className="text-gray-400">Total Profit</div>
                                        <div className={`font-mono font-bold text-sm ${wallet - 100000 >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {wallet - 100000 > 0 ? '+' : ''}{(wallet - 100000).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto p-3 space-y-4">
                        
                        {/* Paddock / Info Panel */}
                        {phase === 'betting' && (
                            <div className="bg-white rounded-xl overflow-hidden shadow-xl relative">
                                <div className="bg-green-800 text-white p-2 font-bold text-center text-sm">Âá∫Ëµ∞Ë°®</div>
                                <div className="divide-y divide-gray-200">
                                    <div className="grid grid-cols-12 text-xs text-gray-500 bg-gray-50 p-2 font-bold text-center">
                                        <div className="col-span-1">Êû†</div>
                                        <div className="col-span-3 text-left pl-2">È¶¨Âêç</div>
                                        <div className="col-span-2">È®éÊâã(„É©„É≥„ÇØ)</div>
                                        <div className="col-span-2">ËÑöË≥™</div>
                                        <div className="col-span-2">È¶¨‰ΩìÈáç(Â¢óÊ∏õ)</div>
                                        <div className="col-span-2">Âçò„Ç™„ÉÉ„Ç∫</div>
                                    </div>
                                    {horses.map(horse => (
                                        <div 
                                            key={horse.id} 
                                            className="grid grid-cols-12 items-center p-2 text-sm hover:bg-yellow-50 relative group"
                                            onMouseEnter={() => setHoveredHorse(horse)}
                                            onMouseLeave={() => setHoveredHorse(null)}
                                        >
                                            <div className="col-span-1 flex justify-center">
                                                <span 
                                                    className="w-6 h-6 rounded flex items-center justify-center font-bold text-xs"
                                                    style={{ backgroundColor: ['white', 'black', '#e53935', '#1e88e5', '#fdd835', '#43a047', '#fb8c00', '#f48fb1'][horse.id % 8], color: horse.id % 8 ===0 || horse.id % 8 === 4 || horse.id % 8 === 7 ?'black':'white', border: horse.id===0?'1px solid #ccc':'none' }}
                                                >
                                                    {horse.number}
                                                </span>
                                            </div>
                                            <div className="col-span-3 pl-2 font-bold text-gray-800 truncate">{horse.name}</div>
                                            <div className="col-span-2 text-center text-xs text-gray-600 truncate">
                                                {horse.jockey} <span className="text-[10px] bg-gray-200 px-1 rounded">{horse.jockeyRank}</span>
                                            </div>
                                            <div className="col-span-2 text-center text-xs text-gray-500">
                                                <span className="px-1 bg-gray-200 rounded">{horse.style.label}</span>
                                            </div>
                                            <div className="col-span-2 text-center text-xs">
                                                {horse.weight}kg <span className={horse.weightDiff > 0 ? "text-red-500 font-bold" : horse.weightDiff < 0 ? "text-blue-500" : "text-gray-400"}>
                                                    ({horse.weightDiff > 0 ? '+' : ''}{horse.weightDiff})
                                                </span>
                                            </div>
                                            <div className="col-span-2 text-right font-mono font-bold text-red-600 pr-2">{horse.odds}</div>
                                        </div>
                                    ))}
                                </div>

                                {/* Horse Info Tooltip */}
                                {hoveredHorse && (
                                    <div 
                                        className="absolute z-50 bg-black/90 text-white p-3 rounded-lg shadow-2xl text-xs pointer-events-none w-48 border border-white/20 backdrop-blur-sm animate-in fade-in zoom-in-95 duration-100"
                                        style={{ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}
                                    >
                                        <div className="font-bold text-yellow-400 text-sm mb-2 border-b border-white/20 pb-1">{hoveredHorse.name}</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <div className="text-gray-400">ÂâçËµ∞È†Ü‰Ωç</div>
                                                <div className="font-bold text-lg">{hoveredHorse.prevRank}ÁùÄ</div>
                                            </div>
                                            <div>
                                                <div className="text-gray-400">ÂâçËµ∞‰ΩìÈáç</div>
                                                <div className="font-bold">{hoveredHorse.weight - hoveredHorse.weightDiff}kg</div>
                                            </div>
                                            <div className="col-span-2 mt-1">
                                                <div className="text-gray-400">Áä∂ÊÖã</div>
                                                <div className={`font-bold ${hoveredHorse.condition > 0.2 ? 'text-red-400' : hoveredHorse.condition < -0.1 ? 'text-blue-400' : 'text-green-400'}`}>
                                                    {hoveredHorse.condition > 0.2 ? 'Áµ∂Â•ΩË™ø' : hoveredHorse.condition > 0 ? 'Â•ΩË™ø' : hoveredHorse.condition > -0.1 ? 'ÊôÆÈÄö' : '‰∏çË™ø'}
                                                    {hoveredHorse.weightDiff > 6 && <span className="ml-2 text-xs bg-red-600 text-white px-1 rounded">Â§™„ÇÅ</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Betting Interface */}
                        {phase === 'betting' && (
                            <div className="bg-white rounded-xl shadow-xl overflow-hidden">
                                
                                {/* Mobile View: Dropdown */}
                                <div className="block md:hidden bg-gray-100 border-b p-2">
                                     <select 
                                        className="w-full p-3 bg-white border border-gray-300 rounded font-bold text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={betType}
                                        onChange={(e) => handleBetTypeChange(e.target.value)}
                                    >
                                        {Object.values(BET_TYPES).map(type => (
                                            <option key={type.id} value={type.id}>
                                                {type.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* Desktop View: Buttons */}
                                <div className="hidden md:flex bg-gray-100 border-b flex-wrap">
                                    {Object.values(BET_TYPES).map(type => (
                                        <button 
                                            key={type.id}
                                            onClick={() => handleBetTypeChange(type.id)}
                                            className={`flex-1 py-3 text-sm font-bold transition-colors min-w-[80px] ${betType === type.id ? 'bg-blue-600 text-white shadow-inner' : 'text-gray-600 hover:bg-gray-200'}`}
                                        >
                                            {type.name}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="p-4 bg-blue-50">
                                    <div className="bg-blue-100 text-blue-800 text-sm p-2 rounded mb-4 border border-blue-200 flex items-center gap-2">
                                        <Info size={16} />
                                        <span>{BET_TYPES[betType].desc}</span>
                                    </div>

                                    <div className="mb-4">
                                        <HorseSelectionRow index={0} label={betType === 'WIDE' || betType === 'TRIO' || betType === 'QUINELLA' || betType === 'PLACE' ? "1È†≠ÁõÆ" : "1ÁùÄ‰∫àÊÉ≥"} />
                                        {BET_TYPES[betType].count >= 2 && (
                                            <HorseSelectionRow index={1} label={betType === 'WIDE' || betType === 'TRIO' || betType === 'QUINELLA' ? "2È†≠ÁõÆ" : "2ÁùÄ‰∫àÊÉ≥"} />
                                        )}
                                        {BET_TYPES[betType].count >= 3 && (
                                            <HorseSelectionRow index={2} label={betType === 'TRIO' ? "3È†≠ÁõÆ" : "3ÁùÄ‰∫àÊÉ≥"} />
                                        )}
                                    </div>

                                    <div className="flex justify-between items-end bg-white p-3 rounded-lg border border-blue-200">
                                        <div>
                                            <div className="text-xs text-gray-500 mb-1">ÁèæÂú®„ÅÆ„Ç™„ÉÉ„Ç∫</div>
                                            <div className="text-3xl font-bold font-mono text-red-600">
                                                {calculateComboOdds(betType, selectedHorses.slice(0, BET_TYPES[betType].count).map(i => i !== null ? horses[i]?.id : undefined), horses) || "---"}
                                                <span className="text-sm text-gray-400 ml-1">ÂÄç</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-sm font-bold text-gray-700">ÈáëÈ°ç</span>
                                                <input 
                                                    type="number" step="100" min="100"
                                                    className="w-24 p-1 border border-gray-400 bg-white text-gray-900 rounded text-right font-mono font-bold focus:outline-none focus:border-blue-500"
                                                    value={betAmount}
                                                    onChange={e => setBetAmount(e.target.value)}
                                                />
                                            </div>
                                            <button 
                                                onClick={addToSlip}
                                                className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow"
                                            >
                                                + ÊäïÁ•®„É™„Çπ„Éà„Å´ËøΩÂä†
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Bet Slip */}
                                {betSlip.length > 0 && (
                                    <div className="bg-gray-800 p-4">
                                        <h3 className="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                                            <Ticket size={16} /> ÊäïÁ•®Ê∏à„Åø„ÉÅ„Ç±„ÉÉ„Éà
                                        </h3>
                                        <div className="space-y-2 mb-4">
                                            {betSlip.map(bet => (
                                                <BettingTicket key={bet.id} bet={bet} onDelete={removeBet} />
                                            ))}
                                        </div>
                                        <div className="flex justify-between items-center pt-2 border-t border-gray-600 text-white">
                                            <div className="text-lg">ÂêàË®à: <span className="font-bold text-yellow-400">{getTotalBetAmount().toLocaleString()}ÂÜÜ</span></div>
                                            <button 
                                                onClick={startRace}
                                                className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-full shadow-lg flex items-center gap-2 animate-pulse"
                                            >
                                                <TrendingUp size={20} />
                                                „É¨„Éº„ÇπÈñãÂßã
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Tipster Modal (Added) */}
                        {phase === 'betting' && <TipsterModal isOpen={showTipster} onClose={() => setShowTipster(false)} onPurchase={purchaseTipsterPrediction} wallet={wallet} budget={tipsterBudget} setBudget={setTipsterBudget} course={tipsterCourse} setCourse={setTipsterCourse} />}

                        {/* Tipster Floating Button (Added) */}
                        {phase === 'betting' && (
                            <button 
                                onClick={() => setShowTipster(true)}
                                className="fixed bottom-6 right-6 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-2xl border-4 border-white animate-bounce z-50 flex items-center justify-center"
                                style={{ width: '64px', height: '64px' }}
                            >
                                <span className="text-3xl">üßô‚Äç‚ôÇÔ∏è</span>
                            </button>
                        )}

                        {/* Fanfare View */}
                        {phase === 'fanfare' && (
                            <div className="flex items-center justify-center h-64">
                                <FanfareView />
                            </div>
                        )}

                        {/* Race View */}
                        {phase === 'racing' && (
                            <div className="space-y-4 animate-in fade-in duration-700">
                                <div className="bg-black text-yellow-400 font-bold text-center py-2 rounded-t-xl border-x-4 border-t-4 border-yellow-700 text-xl tracking-wider">
                                    {commentary}
                                </div>
                                <RaceTrack horses={horses} progress={raceProgress} />
                                
                                {/* Live Ranking */}
                                <div className="bg-black/80 text-white p-3 rounded-b-xl backdrop-blur">
                                    <div className="flex items-center gap-2 text-xs overflow-x-auto pb-1">
                                        <span className="bg-red-600 px-2 rounded font-bold whitespace-nowrap">ÂÖàÈ†≠</span>
                                        {raceRanking.map((h, i) => (
                                            <div key={h.id} className={`flex items-center gap-1 px-2 py-1 rounded shrink-0 ${h.rank ? 'bg-yellow-600 border border-yellow-300' : 'bg-gray-800'}`}>
                                                <span className={`font-bold ${h.rank ? 'text-white' : 'text-yellow-400'}`}>{h.rank ? `${h.rank}ÁùÄ` : i+1}</span>
                                                <span className={`w-4 h-4 rounded text-[10px] flex items-center justify-center bg-white text-black font-bold`}>{h.number}</span>
                                                <span>{h.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* NEW: Betting Tickets Display */}
                                {betSlip.length > 0 && (
                                    <div className="mt-4">
                                        <h3 className="text-white font-bold mb-2 flex items-center gap-2 text-sm px-2">
                                            <Ticket size={16} /> Ë≥ºÂÖ•„Åó„ÅüÈ¶¨Âà∏
                                        </h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 px-2">
                                            {betSlip.map(bet => (
                                                <BettingTicket key={bet.id} bet={bet} onDelete={() => {}} isResult={false} hit={null} readOnly={true} />
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Result Modal */}
                        {phase === 'result' && finalResult && (
                            <div className="bg-white text-gray-900 rounded-xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-300 border-4 border-yellow-400">
                                <div className="bg-yellow-400 p-4 text-center">
                                    <h2 className="text-2xl font-black text-yellow-900">RESULT</h2>
                                </div>
                                <div className="p-4">
                                    <div className="bg-gray-100 rounded-lg p-3 mb-6">
                                        <div className="grid grid-cols-12 text-xs text-gray-500 font-bold border-b pb-2 mb-2">
                                            <div className="col-span-2 text-center">ÁùÄÈ†Ü</div>
                                            <div className="col-span-5 pl-1">È¶¨Âêç</div>
                                            <div className="col-span-2 text-center">ËÑöË≥™</div>
                                            <div className="col-span-3 text-right pr-2">„Ç™„ÉÉ„Ç∫</div>
                                        </div>
                                        <div className="space-y-2">
                                            {/* Show all horses in result */}
                                            {finalResult.map((h, i) => (
                                                <div key={h.id} className={`grid grid-cols-12 items-center text-sm p-1 rounded ${i===0 ? 'bg-yellow-200 font-bold' : i===1?'bg-gray-200':i===2?'bg-orange-100':''}`}>
                                                    <div className="col-span-2 text-center">
                                                        <span className={`inline-block w-6 h-6 rounded-full leading-6 ${i===0?'bg-yellow-500 text-white':i===1?'bg-gray-400 text-white':i===2?'bg-orange-400 text-white':'text-gray-500'}`}>{i+1}</span>
                                                    </div>
                                                    <div className="col-span-5 flex items-center gap-1 pl-1">
                                                        <span className={`w-4 h-4 rounded text-[10px] flex items-center justify-center bg-gray-800 text-white font-bold`}>{h.number}</span>
                                                        <span className="truncate">{h.name}</span>
                                                    </div>
                                                    <div className="col-span-2 text-center text-xs text-gray-500">{h.style.label}</div>
                                                    <div className="col-span-3 text-right font-mono text-red-600 pr-2">{h.odds}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* User's Bets Result */}
                                    {betSlip.length > 0 && (
                                        <div className="mb-6">
                                            <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2 text-sm">
                                                <Ticket size={16} /> „ÅÇ„Å™„Åü„ÅÆÊäïÁ•®ÁµêÊûú
                                            </h3>
                                            <div className="space-y-2">
                                                {betSlip.map(bet => (
                                                    <BettingTicket 
                                                        key={bet.id} 
                                                        bet={bet} 
                                                        isResult={true}
                                                        hit={checkWin(bet, finalResult)}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="text-center border-t pt-4">
                                        <div className="text-gray-500 mb-1 text-sm">‰ªäÂõû„ÅÆÂèéÊîØ</div>
                                        {(() => {
                                            const log = resultLog[0];
                                            if (!log) return null;
                                            const balance = log.payout - log.betTotal;
                                            const isPlus = balance >= 0;
                                            
                                            return (
                                                <div className="mb-6">
                                                    <div className={`text-4xl font-black font-mono ${isPlus ? 'text-green-600' : 'text-red-600'}`}>
                                                        {isPlus ? '+' : ''}{balance.toLocaleString()}
                                                    </div>
                                                    <div className="text-xs sm:text-sm text-gray-500 font-bold mt-1">
                                                        (ÊâïÊàªÔºö{log.payout.toLocaleString()}„ÄÅÈ¶¨Âà∏Ë≥ºÂÖ•Ôºö-{log.betTotal.toLocaleString()})
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                        
                                        <button 
                                            onClick={nextRace}
                                            className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-12 rounded-full shadow-lg flex items-center gap-2 mx-auto w-full justify-center sm:w-auto transform transition hover:scale-105"
                                        >
                                            <RotateCcw size={20} />
                                            Ê¨°„ÅÆ„É¨„Éº„Çπ„Å∏
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>