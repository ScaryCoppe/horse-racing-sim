<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GI„Éâ„É™„Éº„É† & Dream Parade</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* --- Normal Mode Styles --- */
        .mode-normal-body {
            background-color: #1a2e1a;
            color: #fff;
        }
        .grass-pattern-normal {
            background-color: #2d5a27;
            background-image: linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
        }
        .ticket-pattern-normal {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* --- Kirakira Mode Styles --- */
        .mode-kirakira-body {
            background:
                radial-gradient(circle at 10% 0%, #ffe6fa 0, transparent 40%),
                radial-gradient(circle at 90% 0%, #e0f2ff 0, transparent 40%),
                radial-gradient(circle at 0% 100%, #ffe4e6 0, transparent 40%),
                radial-gradient(circle at 100% 100%, #e9d5ff 0, transparent 40%),
                linear-gradient(180deg, #fff5fb 0, #f0f9ff 50%, #ffeef7 100%);
            color: #4b3b52;
            background-attachment: fixed;
        }
        .grass-pattern-kirakira {
            background-color: #ffe4f5;
            background-image:
                linear-gradient(0deg,
                    transparent 24%,
                    rgba(255, 255, 255, .7) 25%,
                    rgba(255, 255, 255, .7) 26%,
                    transparent 27%,
                    transparent 74%,
                    rgba(255, 255, 255, .7) 75%,
                    rgba(255, 255, 255, .7) 76%,
                    transparent 77%,
                    transparent),
                linear-gradient(90deg,
                    transparent 24%,
                    rgba(255, 255, 255, .7) 25%,
                    rgba(255, 255, 255, .7) 26%,
                    transparent 27%,
                    transparent 74%,
                    rgba(255, 255, 255, .7) 75%,
                    rgba(255, 255, 255, .7) 76%,
                    transparent 77%,
                    transparent);
            background-size: 50px 50px;
        }
        .ticket-pattern-kirakira {
            background-image: radial-gradient(#fde7ff 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* --- Shared / Utility --- */
        .stamp-hit { transform: rotate(-12deg); }
        .stamp-miss { transform: rotate(12deg); }

        @keyframes gallop {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-1px) rotate(-1deg); }
            50% { transform: translateY(-2px) rotate(0deg); }
            75% { transform: translateY(-1px) rotate(1deg); }
        }
        .horse-gallop { animation: gallop 0.6s infinite; }
        
        .history-scroll::-webkit-scrollbar { width: 6px; }
        .history-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .history-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Shared Icons ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Coins = (p) => <IconBase {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Ticket = (p) => <IconBase {...p}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconBase>;
        const SwitchIcon = (p) => <IconBase {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>;

        const resetGame = () => {
            if (confirm("„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Å¶ÊúÄÂàù„Åã„ÇâÈÅä„Å≥„Åæ„Åô„ÅãÔºü\nÔºàÊâÄÊåÅÈáë„ÄÅÊà¶Á∏æ„Åå„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„ÅôÔºâ")) {
                localStorage.removeItem('g1dream_wallet');
                localStorage.removeItem('g1dream_raceCount');
                localStorage.removeItem('g1dream_resultLog');
                window.location.reload();
            }
        };

        // ============================================================================================
        //  MODE: NORMAL (GI„Éâ„É™„Éº„É†)
        // ============================================================================================
        const NormalMode = ({ wallet, setWallet, raceCount, setRaceCount, resultLog, setResultLog, onOpenSwitch }) => {
            const RACE_TOTAL_DISTANCE = 2142; 
            const HORSE_NAMES_PREFIX = ["„Éñ„É©„ÉÉ„ÇØ", "„Çµ„Ç§„É¨„É≥„Çπ", "„Éá„Ç£„Éº„Éó", "„Çπ„Éö„Ç∑„É£„É´", "„Ç¥„Éº„É´„Éâ", "„É°„Ç∏„É≠", "„Éà„Ç¶„Ç´„Ç§", "„Éä„É™„Çø", "„Ç™„Ç∞„É™", "„Éü„Çπ„Çø„Éº", "„Ç≠„É≥„Ç∞", "„Çµ„ÇØ„É©", "„ÉÄ„Ç§„ÉØ", "„Ç¶„Ç™„ÉÉ„Ç´", "„Ç∑„É≥„Éú„É™", "„Ç®„Ç¢", "„Ç¢„Ç∞„Éç„Çπ", "„Éû„É≥„Éè„ÉÉ„Çø„É≥", "„Éï„Ç∏", "„Ç∞„É©„Çπ", "„Ç®„É´", "„Éû„É§„Éé", "„Éì„ÉØ", "„É©„Ç§„Çπ"];
            const HORSE_NAMES_SUFFIX = ["„Ç§„É≥„Éë„ÇØ„Éà", "„Çπ„Ç∫„Ç´", "„Ç¶„Ç£„Éº„ÇØ", "„Ç∑„ÉÉ„Éó", "„Éû„ÉÉ„ÇØ„Ç§„Éº„É≥", "„ÉÜ„Ç§„Ç™„Éº", "„Éñ„É©„Ç§„Ç¢„É≥", "„Ç≠„É£„ÉÉ„Éó", "„Ç∑„Éº„Éì„Éº", "„Éò„Ç§„É≠„Éº", "„Éê„ÇØ„Ç∑„É≥", "„Çπ„Ç´„Éº„É¨„ÉÉ„Éà", "„É´„Éâ„É´„Éï", "„Ç∞„É´„Éº„É¥", "„Éá„Ç∏„Çø„É´", "„Ç´„Éï„Çß", "„Ç≠„Çª„Ç≠", "„ÉØ„É≥„ÉÄ„Éº", "„Ç≥„É≥„Éâ„É´", "„Éà„ÉÉ„Éó„Ç¨„É≥"];
            const JOCKEYS = [{ name: "Ê≠¶ Ë±ä", weight: 10, rank: "S" }, { name: "„É´„É°„Éº„É´", weight: 10, rank: "S" }, { name: "Â∑ùÁî∞", weight: 9, rank: "A" }, { name: "„Éá„É†„Éº„É≠", weight: 9, rank: "A" }, { name: "Ê®™Â±±", weight: 8, rank: "A" }, { name: "Êà∏Â¥é", weight: 8, rank: "A" }, { name: "Á¶èÊ∞∏", weight: 8, rank: "A" }, { name: "Ê±†Ê∑ª", weight: 8, rank: "A" }, { name: "Â≤©Áî∞", weight: 7, rank: "B" }, { name: "ÊùæÂ±±", weight: 7, rank: "B" }, { name: "ÂùÇ‰∫ï", weight: 7, rank: "B" }, { name: "ÂíåÁî∞", weight: 6, rank: "C" }, { name: "Êµú‰∏≠", weight: 6, rank: "C" }, { name: "‰∏âÊµ¶", weight: 5, rank: "C" }, { name: "Âπ∏", weight: 5, rank: "C" }, { name: "Ëó§Áî∞", weight: 4, rank: "D" }, { name: "Êñ∞‰∫∫", weight: 3, rank: "D" }];
            const RUNNING_STYLES = [{ id: 0, name: "ÈÄÉ„Åí", label: "ÈÄÉ", desc: "Â∫èÁõ§„Åã„ÇâÂÖàÈ†≠„Å´Á´ã„Å§" }, { id: 1, name: "ÂÖàË°å", label: "ÂÖà", desc: "Â•Ω‰Ωç„Å´„Å§„Åë„Å¶Êäú„ÅëÂá∫„Åô" }, { id: 2, name: "Â∑Æ„Åó", label: "Â∑Æ", desc: "‰∏≠Âõ£„Åã„ÇâÊú´ËÑö„Çí‰º∏„Å∞„Åô" }, { id: 3, name: "ËøΩËæº", label: "ËøΩ", desc: "ÂæåÊñπ„Åã„Çâ‰∏ÄÊ∞ó„Å´„Åî„Åº„ÅÜÊäú„Åç" }];
            const BET_TYPES = { WIN: { id: 'WIN', name: 'ÂçòÂãù', count: 1, desc: '1ÁùÄ„Å´„Å™„ÇãÈ¶¨„ÇíÂΩì„Å¶„Åæ„Åô' }, PLACE: { id: 'PLACE', name: 'Ë§áÂãù', count: 1, desc: '3ÁùÄ‰ª•ÂÜÖ„Å´ÂÖ•„ÇãÈ¶¨„ÇíÂΩì„Å¶„Åæ„Åô' }, QUINELLA: { id: 'QUINELLA', name: 'È¶¨ÈÄ£', count: 2, desc: '1ÁùÄ„Å®2ÁùÄ„Å´„Å™„ÇãÈ¶¨„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂΩì„Å¶„Åæ„ÅôÔºàÈ†Ü‰∏çÂêåÔºâ' }, WIDE: { id: 'WIDE', name: '„ÉØ„Ç§„Éâ', count: 2, desc: '3ÁùÄ‰ª•ÂÜÖ„Å´ÂÖ•„ÇãÈ¶¨„ÅÆ„ÅÜ„Å°„ÄÅ2È†≠„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂΩì„Å¶„Åæ„ÅôÔºàÈ†Ü‰∏çÂêåÔºâ' }, EXACTA: { id: 'EXACTA', name: 'È¶¨Âçò', count: 2, desc: '1ÁùÄ„Å®2ÁùÄ„Å´„Å™„ÇãÈ¶¨„Çí„ÄÅÁùÄÈ†ÜÈÄö„Çä„Å´ÂΩì„Å¶„Åæ„Åô' }, TRIO: { id: 'TRIO', name: '3ÈÄ£Ë§á', count: 3, desc: '1ÁùÄ„ÄÅ2ÁùÄ„ÄÅ3ÁùÄ„Å´„Å™„ÇãÈ¶¨„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂΩì„Å¶„Åæ„ÅôÔºàÈ†Ü‰∏çÂêåÔºâ' }, TRIFECTA: { id: 'TRIFECTA', name: '3ÈÄ£Âçò', count: 3, desc: '1ÁùÄ„ÄÅ2ÁùÄ„ÄÅ3ÁùÄ„Å´„Å™„ÇãÈ¶¨„Çí„ÄÅÁùÄÈ†ÜÈÄö„Çä„Å´ÂΩì„Å¶„Åæ„Åô' }};
            const TIPSTER_COURSES = { SOLID: { id: 'SOLID', name: 'Â†ÖÂÆü„Ç≥„Éº„Çπ', desc: 'ÁöÑ‰∏≠ÁéáÈáçË¶ñÔºÅ„Ç≥„ÉÑ„Ç≥„ÉÑÁ®º„Åé„Åü„ÅÑ„ÅÇ„Å™„Åü„Å´„ÄÇ', type: 'PLACE' }, BALANCE: { id: 'BALANCE', name: '„Éê„É©„É≥„Çπ„Ç≥„Éº„Çπ', desc: 'ÂõûÂèéÁéáÈáçË¶ñ„ÄÇÈ¶¨ÈÄ£„Åß„Åó„Å£„Åã„ÇäÂà©Áõä„ÇíÔºÅ', type: 'QUINELLA' }, DREAM: { id: 'DREAM', name: '‰∏ÄÊî´ÂçÉÈáë„Ç≥„Éº„Çπ', desc: 'Â§¢„ÅÆ‰∏áÈ¶¨Âà∏ÔºÅÁ©¥È¶¨„ÇíÁµ°„ÇÅ„Åü3ÈÄ£ÂçòÂãùË≤†ÔºÅ', type: 'TRIFECTA' }};

            const [phase, setPhase] = useState('betting'); 
            const [horses, setHorses] = useState([]);
            const [betType, setBetType] = useState('WIN');
            const [selectedHorses, setSelectedHorses] = useState([null, null, null]); 
            const [betAmount, setBetAmount] = useState(1000); 
            const [betSlip, setBetSlip] = useState([]); 
            const [raceProgress, setRaceProgress] = useState([]); 
            const [raceTime, setRaceTime] = useState(0);
            const [raceRanking, setRaceRanking] = useState([]); 
            const [finalResult, setFinalResult] = useState(null);
            const [commentary, setCommentary] = useState("„Éë„Éâ„ÉÉ„ÇØÂë®Âõû‰∏≠...");
            const [showHistory, setShowHistory] = useState(false); 
            const [hoveredHorse, setHoveredHorse] = useState(null);
            const [showTipster, setShowTipster] = useState(false);
            const [tipsterBudget, setTipsterBudget] = useState(1000);
            const [tipsterCourse, setTipsterCourse] = useState('SOLID');
            const animationRef = useRef(null);

            // --- Betting Ticket Component (Normal Mode) ---
            const BettingTicket = ({ bet, onDelete, isResult, hit, readOnly }) => (
                <div className={`bg-white border-2 ${isResult ? (hit ? 'border-red-500' : 'border-gray-400') : (bet.isTipster ? 'border-purple-600' : 'border-green-700')} rounded shadow-md relative overflow-hidden font-mono w-full mb-3 max-w-sm mx-auto transform transition ${!isResult && 'hover:scale-[1.02]'}`}>
                    <div className={`${isResult ? (hit ? 'bg-red-500' : 'bg-gray-500') : (bet.isTipster ? 'bg-purple-600' : 'bg-green-700')} text-white text-xs px-2 py-1 flex justify-between items-center`}>
                        <span className="font-bold flex items-center gap-1">
                            {bet.isTipster ? <Sparkles size={12} /> : <Ticket size={12} />}
                            {bet.isTipster ? '‰∫àÊÉ≥Â±ãÊú¨Ëàó' : 'Èò™Á•ûÁ´∂È¶¨Â†¥'}
                        </span>
                        <span>{new Date(bet.id).toLocaleTimeString()} Áô∫Âà∏</span>
                    </div>
                    
                    <div className="p-3 text-gray-800 ticket-pattern-normal relative">
                        <div className="flex justify-between items-end border-b-2 border-dashed border-gray-300 pb-2 mb-2">
                            <div>
                                <div className="text-xs text-gray-500 font-bold mb-1">{bet.typeName}</div>
                                <div className="text-2xl font-black tracking-widest">
                                    {bet.selection.map(h => h.number).join(bet.type === 'TRIFECTA' ? ' ‚Üí ' : ' - ')}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-gray-500">„Ç™„ÉÉ„Ç∫</div>
                                <div className="text-lg font-bold text-red-600">{bet.odds}ÂÄç</div>
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-center">
                            <div className="text-sm font-bold">
                                {bet.amount.toLocaleString()}ÂÜÜ
                            </div>
                            {!isResult && !readOnly && ( 
                                <button 
                                    onClick={() => onDelete(bet.id)}
                                    className="text-gray-400 hover:text-red-500 transition-colors p-1"
                                    title="Âèñ„ÇäÊ∂à„Åó"
                                >
                                    <Trash2 size={16} />
                                </button>
                            )}
                            {isResult && (
                                <div className="text-sm font-bold">
                                    {hit ? <span className="text-red-600">ÁöÑ‰∏≠ÔºÅ</span> : <span className="text-gray-400">„Éè„Ç∫„É¨</span>}
                                </div>
                            )}
                        </div>
                        
                        {isResult && hit && (
                             <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 stamp-hit border-4 font-black text-3xl px-2 select-none pointer-events-none opacity-80">
                                HIT
                            </div>
                        )}
                        {isResult && !hit && (
                             <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 stamp-miss border-4 font-black text-3xl px-2 select-none pointer-events-none opacity-40">
                                LOSE
                            </div>
                        )}
                        {!isResult && (
                             <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-4 ${bet.isTipster ? 'border-purple-500/20 text-purple-500/20' : 'border-red-500/20 text-red-500/20'} font-black text-3xl rotate-12 px-2 select-none pointer-events-none`}>
                                {bet.isTipster ? 'PRO' : 'VOTE'}
                            </div>
                        )}
                    </div>
                </div>
            );

            const calculateComboOdds = (type, horseIndices, horses) => {
                if (!horseIndices.every(idx => idx !== null && idx !== undefined)) return 0;
                const probs = horseIndices.map(idx => 1 / horses[idx].odds); 
                let jointProb = 1;
                if (type === 'WIN') jointProb = probs[0];
                else if (type === 'PLACE') jointProb = probs[0] * 3.0;
                else if (type === 'QUINELLA') jointProb = probs[0] * probs[1] * 2.5; 
                else if (type === 'WIDE') jointProb = probs[0] * probs[1] * 4.5; 
                else if (type === 'EXACTA') jointProb = probs[0] * probs[1] * 1.2;
                else if (type === 'TRIO') jointProb = probs[0] * probs[1] * probs[2] * 7.0; 
                else if (type === 'TRIFECTA') jointProb = probs[0] * probs[1] * probs[2] * 1.5; 
                let odds = (1 / jointProb) * 0.75; 
                if (type !== 'WIN' && odds < 1.1) odds = 1.1;
                if (type === 'PLACE' && odds < 1.0) odds = 1.0; 
                return Math.min(99999.9, Math.max(1.0, parseFloat(odds.toFixed(1))));
            };
            
            const checkWin = (bet, finishOrder) => {
                if (!finishOrder || finishOrder.length < 3) return false;
                const ids = bet.selection.map(h => h.id);
                const r1 = finishOrder[0].id; const r2 = finishOrder[1].id; const r3 = finishOrder[2].id;
                if (bet.type === 'WIN') return ids[0] === r1;
                else if (bet.type === 'PLACE') return ids[0] === r1 || ids[0] === r2 || ids[0] === r3;
                else if (bet.type === 'QUINELLA') { const top2 = [r1, r2]; return top2.includes(ids[0]) && top2.includes(ids[1]); }
                else if (bet.type === 'WIDE') { const top3 = [r1, r2, r3]; return top3.includes(ids[0]) && top3.includes(ids[1]); }
                else if (bet.type === 'EXACTA') return ids[0] === r1 && ids[1] === r2;
                else if (bet.type === 'TRIO') { const top3 = [r1, r2, r3].sort().join(','); const sel = [...ids].sort().join(','); return top3 === sel; }
                else if (bet.type === 'TRIFECTA') return ids[0] === r1 && ids[1] === r2 && ids[2] === r3;
                return false;
            };

            const setupRace = () => {
                const numHorses = 8; const newHorses = []; let totalPopularityScore = 0; const usedNames = new Set(); const usedJockeys = new Set(); let strengthPool = [];
                const racePattern = Math.random(); let patternName = "";
                if (racePattern < 0.3) { patternName = "1Âº∑"; strengthPool.push(95 + Math.random() * 10); for(let k=0; k<7; k++) strengthPool.push(65 + Math.random() * 25); } 
                else if (racePattern < 0.6) { patternName = "2Âº∑"; strengthPool.push(90 + Math.random() * 8); strengthPool.push(90 + Math.random() * 8); for(let k=0; k<6; k++) strengthPool.push(65 + Math.random() * 25); } 
                else if (racePattern < 0.8) { patternName = "3Âº∑"; for(let k=0; k<3; k++) strengthPool.push(85 + Math.random() * 10); for(let k=0; k<5; k++) strengthPool.push(65 + Math.random() * 25); } 
                else { patternName = "Ê∑∑Êà¶"; const baseStrength = 60 + Math.random() * 10; for(let k=0; k<8; k++) strengthPool.push(baseStrength + (Math.random() - 0.5) * 20); }
                strengthPool.sort(() => Math.random() - 0.5);

                for (let i = 0; i < numHorses; i++) {
                    const strength = Math.max(20, Math.min(120, strengthPool[i]));
                    let name = HORSE_NAMES_PREFIX[Math.floor(Math.random() * HORSE_NAMES_PREFIX.length)] + HORSE_NAMES_SUFFIX[Math.floor(Math.random() * HORSE_NAMES_SUFFIX.length)];
                    while(usedNames.has(name)) { name = HORSE_NAMES_PREFIX[Math.floor(Math.random() * HORSE_NAMES_PREFIX.length)] + HORSE_NAMES_SUFFIX[Math.floor(Math.random() * HORSE_NAMES_SUFFIX.length)]; }
                    usedNames.add(name);
                    let jockey = JOCKEYS[Math.floor(Math.random() * JOCKEYS.length)];
                    while(usedJockeys.has(jockey.name)) { jockey = JOCKEYS[Math.floor(Math.random() * JOCKEYS.length)]; }
                    usedJockeys.add(jockey.name);
                    const perfBase = 120 - strength + (Math.random() * 30 - 15); 
                    let prevRank = perfBase < 30 ? 1 : perfBase < 40 ? 2 : perfBase < 50 ? 3 : perfBase < 60 ? 4 : perfBase < 80 ? Math.floor(Math.random()*2)+5 : Math.floor(Math.random()*2)+7; if(prevRank > 8) prevRank = 8;
                    const baseWeight = 460 + Math.floor(Math.random() * 80); const weightDiff = Math.floor(Math.random() * 16) - 8;
                    newHorses.push({ id: i, number: i + 1, name: name, jockey: jockey.name, jockeyWeight: jockey.weight, jockeyRank: jockey.rank, strength: strength, stamina: Math.random() * 0.4 + 0.8, style: RUNNING_STYLES[Math.floor(Math.random() * RUNNING_STYLES.length)], condition: (Math.random() * 0.6) - 0.3, prevRank: prevRank, weight: baseWeight + weightDiff, weightDiff: weightDiff, odds: 0 });
                }
                newHorses.forEach(h => {
                    let rankScore = h.prevRank === 1 ? 100 : h.prevRank === 2 ? 80 : h.prevRank === 3 ? 60 : h.prevRank <= 5 ? 40 : 20;
                    h.popularity = Math.pow(rankScore + (h.jockeyWeight * 3) + ((h.strength * 0.4) + (h.condition * 20) + (Math.random() * 10)), 2.5);
                    totalPopularityScore += h.popularity;
                });
                newHorses.forEach(horse => {
                    let rawOdds = (1 / (horse.popularity / totalPopularityScore)) * 0.8; 
                    if (rawOdds < 1.1) rawOdds = 1.1; if (rawOdds > 300.0) rawOdds = 300.0 + (Math.random() * 200); 
                    horse.odds = parseFloat(rawOdds.toFixed(1));
                });

                if (Math.random() < 0.08) { 
                    const darkHorses = newHorses.filter(h => h.odds >= 15.0);
                    if (darkHorses.length > 0) {
                        const buffedHorse = darkHorses[Math.floor(Math.random() * darkHorses.length)];
                        buffedHorse.condition = 0.3; 
                        buffedHorse.strength += 8; 
                    }
                }

                setHorses(newHorses); setBetSlip([]); setRaceProgress(newHorses.map(h => ({ id: h.id, dist: 0, speed: 0, lane: h.id, rank: null, status: 'normal', maxSpeed: (h.strength / 100) + 0.8 })));
                setFinalResult(null); setPhase('betting'); setCommentary(`Á¨¨${raceCount}„É¨„Éº„Çπ (${patternName})„ÄÅÊäïÁ•®Âèó‰ªò‰∏≠ÔºÅ`); setSelectedHorses([null, null, null]);
            };
            useEffect(() => setupRace(), [raceCount]); 

            // ‚òÖ‰øÆÊ≠£: „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíËøΩÂä†
            useEffect(() => {
                return () => {
                    if (animationRef.current) cancelAnimationFrame(animationRef.current);
                };
            }, []);

            const purchaseTipster = () => {
                // ‚òÖ‰øÆÊ≠£: „É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÄåÂÄüÈáë„Åó„Å¶Ë≥ºÂÖ•Ôºü„Äç„Åã„Çâ„ÄåÊîØÊâï„ÅÑ„ÅØÁô∫Ëµ∞ÊôÇ„Å´„Åæ„Å®„ÇÅ„Å¶ÔºàÂÄüÈáë„Å´„Å™„Çã„Åã„ÇÇÔºâ„Äç„Å´Â§âÊõ¥
                if (tipsterBudget > wallet && wallet >= 100) alert("ÊâÄÊåÅÈáë„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ‰∫àÊÉ≥„ÉÅ„Ç±„ÉÉ„Éà„ÇíÁô∫Ë°å„Åó„Åæ„Åô„ÄÇ\n‰ª£Èáë„ÅØ„É¨„Éº„ÇπÁô∫Ëµ∞ÊôÇ„Å´„Åæ„Å®„ÇÅ„Å¶Á≤æÁÆó„Åï„Çå„Åæ„ÅôÔºàÂÄüÈáë„Å´„Å™„Çä„Åæ„ÅôÔºâ„ÄÇ");
                else if (tipsterBudget <= 0) { alert("‰∫àÁÆó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }
                
                const scoredHorses = horses.map(h => ({
                    ...h,
                    tipsterScore: (h.strength * 0.4) + (h.condition * 50) + (h.jockeyWeight * 2) + ((Math.random() - 0.5) * 30)
                })).sort((a, b) => b.tipsterScore - a.tipsterScore);

                let type='', sel=[];
                if (tipsterCourse === 'SOLID') { type = 'PLACE'; sel = [scoredHorses[0]]; } 
                else if (tipsterCourse === 'BALANCE') { type = 'QUINELLA'; sel = [scoredHorses[0], scoredHorses[1]]; } 
                else if (tipsterCourse === 'DREAM') { 
                    const darkHorses = horses.filter(h => h.odds >= 10.0).sort((a, b) => b.condition - a.condition);
                    const dark = darkHorses.length > 0 ? darkHorses[0] : scoredHorses[2];
                    sel = [scoredHorses[0], scoredHorses[1]];
                    if (sel.some(p => p.id === dark.id)) sel.push(scoredHorses[2]); else sel.push(dark);
                    type = 'TRIFECTA'; 
                }
                const newBet = { id: Date.now(), type, typeName: BET_TYPES[type].name, selection: sel, amount: parseInt(tipsterBudget), odds: calculateComboOdds(type, sel.map(s => s.id), horses), isTipster: true };
                setBetSlip(prev => [...prev, newBet]); setShowTipster(false); alert("‰∫àÊÉ≥„ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅÊäïÁ•®„É™„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            };
            const addToSlip = () => {
                const req = BET_TYPES[betType].count; const sel = selectedHorses.slice(0, req);
                if (sel.includes(null)) { alert("È¶¨„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
                if (new Set(sel).size !== sel.length) { alert("Âêå„ÅòÈ¶¨„ÇíÈáçË§á„Åó„Å¶ÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„Çì"); return; }
                if (betAmount <= 0) return;
                const newBet = { id: Date.now(), type: betType, typeName: BET_TYPES[betType].name, selection: sel.map(idx => horses[idx]), amount: parseInt(betAmount), odds: calculateComboOdds(betType, sel.map(i => horses[i].id), horses), isTipster: false };
                setBetSlip([...betSlip, newBet]);
            };
            const startRace = () => {
                const total = betSlip.reduce((s, b) => s + b.amount, 0);
                if (total === 0 && !confirm("Ë≥≠„ÅëÈáë„Å™„Åó„ÅßË¶≥Êà¶„Åó„Åæ„Åô„ÅãÔºü")) return;
                if (total > wallet && !confirm(`Ë≥áÈáë„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ\nÊÆãÈ´ò: ${wallet.toLocaleString()}ÂÜÜ\nË≥≠„ÅëÈáë: ${total.toLocaleString()}ÂÜÜ\n\nÂÄüÈáë„Åó„Å¶Ë≥≠„Åë„Åæ„Åô„ÅãÔºü`)) return;
                setWallet(prev => prev - total); setPhase('fanfare'); setCommentary("„Åæ„ÇÇ„Å™„ÅèÁô∫Ëµ∞„Åß„Åô...");
                setTimeout(() => setCommentary("„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨„ÅåÈ≥¥„ÇäÈüø„Åç„Åæ„ÅôÔºÅ"), 300); setTimeout(() => setCommentary("ÂêÑÈ¶¨„Ç≤„Éº„Éà„Ç§„É≥ÂÆå‰∫Ü..."), 1800);
                setTimeout(() => { setPhase('racing'); setCommentary("„Çπ„Çø„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ"); runRace(); }, 2500);
            };
            const runRace = () => {
                let currentProgress = horses.map(h => ({ id: h.id, dist: 0, speed: 0, fatigue: 0, rank: null, status: 'normal', maxSpeed: (h.strength / 100) + 0.8 }));
                currentProgress = currentProgress.map(p => { if (Math.random() < (10 - horses[p.id].jockeyWeight) * 0.008) p.status = 'late_start'; return p; });
                setRaceProgress(currentProgress);
                let time = 0, nextRank = 1, finishedOrder = [];
                const loop = () => {
                    time += 0.1;
                    currentProgress = currentProgress.map(p => {
                        if (p.rank !== null) return p;
                        const horse = horses.find(h => h.id === p.id);
                        let targetSpeed = p.maxSpeed * (1 + (horse.condition * 0.3) - (horse.weightDiff > 0 ? horse.weightDiff * 0.005 : 0));
                        const pct = p.dist / RACE_TOTAL_DISTANCE;
                        if (p.status === 'late_start') { targetSpeed *= 0.5; if (pct > 0.05 + Math.random() * 0.05) p.status = 'normal'; }
                        if (pct > 0.2 && pct < 0.7 && p.status === 'normal' && Math.random() < (10 - horse.jockeyWeight) * 0.0005) p.status = 'kakari';
                        if (p.status === 'kakari') { targetSpeed *= 1.15; p.fatigue += p.speed * 0.07; if (Math.random() < 0.03) p.status = 'normal'; } else p.fatigue += p.speed * 0.02 * (1.0 - horse.jockeyWeight * 0.02);
                        if (pct < 0.15) { if (horse.style.id === 0) targetSpeed *= 1.2; else if (horse.style.id === 3) targetSpeed *= 0.8; } 
                        else if (pct < 0.6) { targetSpeed *= 0.9; if (Math.random() < 0.005) targetSpeed *= 1.1; } 
                        else if (pct < 0.85) { if (horse.style.id === 1) targetSpeed *= 1.1; if (horse.style.id === 2) targetSpeed *= 1.2; } 
                        else { if (horse.style.id === 3) targetSpeed *= 1.5; else if (horse.style.id === 0) targetSpeed *= 0.8; else targetSpeed *= 1.0; 
                            if (p.fatigue > horse.strength * horse.stamina * 0.9) { targetSpeed *= (1.0 - Math.min(0.4, (p.fatigue - horse.strength * horse.stamina * 0.9) * 0.05)); p.status = 'tired'; }
                        }
                        p.speed += ((targetSpeed - p.speed) * 0.02) + (Math.random() - 0.5) * 0.3; if(p.speed < 0.2) p.speed = 0.2;
                        p.dist += p.speed;
                        if (p.dist >= RACE_TOTAL_DISTANCE) { p.dist = RACE_TOTAL_DISTANCE; p.rank = nextRank++; finishedOrder.push(horse); }
                        return p;
                    });
                    const sorted = [...currentProgress].sort((a, b) => (a.rank ?? 999) - (b.rank ?? 999) || b.dist - a.dist);
                    setRaceRanking(sorted.map(p => ({ ...horses.find(h => h.id === p.id), rank: p.rank }))); setRaceProgress([...currentProgress]); setRaceTime(time);
                    if (Math.floor(time * 10) % 50 === 0) {
                        const leader = sorted[0], pct = leader.dist / RACE_TOTAL_DISTANCE;
                        if (pct < 0.15) setCommentary(currentProgress.some(p=>p.status==='late_start') ? `„Åä„Å£„Å®ÔºÅÂá∫ÈÅÖ„Çå„ÅåÁô∫Áîü„ÄÇ` : `ÂêÑÈ¶¨„ÄÅ„Åç„Çå„ÅÑ„Å™„Çπ„Çø„Éº„Éà„ÇíÂàá„Çä„Åæ„Åó„Åü„ÄÇ`);
                        else if (pct < 0.4) setCommentary(currentProgress.some(p=>p.status==='kakari') ? `${horses[currentProgress.find(p=>p.status==='kakari').id].name}„ÄÅË°å„Åç„Åü„Åå„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ` : `${horses[leader.id].name}„Åå„É¨„Éº„Çπ„ÇíÂºï„Å£Âºµ„ÇãÔºÅ`);
                        else if (pct < 0.6) setCommentary(`„É¨„Éº„Çπ„ÅØ‰∏≠Áõ§„ÄÅ${horses[leader.id].name}„ÅåÂÖàÈ†≠„Çí„Ç≠„Éº„Éó„ÄÇ`);
                        else if (pct < 0.95) setCommentary(currentProgress.find(p=>p.status==='tired' && p.id===leader.id) ? `${horses[leader.id].name}„ÄÅË∂≥Ëâ≤„ÅåÈàç„Å£„ÅüÔºÅ` : `${horses[leader.id].name}„ÄÅÂÖàÈ†≠„Å†ÔºÅÊäº„ÅóÂàá„Çå„Çã„ÅãÔºÅÔºü`);
                        else if (!finalResult) setCommentary(`„Ç¥„Éº„É´„Åæ„Åß„ÅÇ„Å®Â∞ë„ÅóÔºÅ`);
                    }
                    if (nextRank > horses.length) { setFinalResult(finishedOrder); setPhase('result'); processResults(finishedOrder); cancelAnimationFrame(animationRef.current); } else animationRef.current = requestAnimationFrame(loop);
                };
                animationRef.current = requestAnimationFrame(loop);
            };
            const processResults = (order) => {
                setCommentary(`1ÁùÄ ${order[0].name}ÔºÅ „Ç¥„Éº„É´„Ç§„É≥ÔºÅ`); let totalPayout = 0;
                betSlip.forEach(bet => { if (checkWin(bet, order)) totalPayout += Math.floor(bet.amount * bet.odds); });
                setWallet(prev => prev + totalPayout);
                setResultLog(prev => [{ race: raceCount, winner: order[0].name, betTotal: betSlip.reduce((s, b) => s + b.amount, 0), payout: totalPayout }, ...prev]);
            };

            const handleBetTypeChange = (newType) => {
                setBetType(newType);
                setSelectedHorses([null, null, null]);
            };

            return (
                <div className="min-h-screen pb-24 font-sans text-white">
                    <header className="bg-gray-900 text-white p-3 sticky top-0 z-20 shadow-lg border-b-4 border-yellow-600 flex justify-between items-center">
                        <div className="flex items-center gap-2" onClick={phase === 'racing' ? null : resetGame} style={{ cursor: phase === 'racing' ? 'not-allowed' : 'pointer', opacity: phase === 'racing' ? 0.5 : 1 }}>
                            <Trophy className="text-yellow-400" size={24} />
                            <div>
                                <h1 className="font-bold text-lg leading-tight flex items-center gap-2">
                                    GI „Éâ„É™„Éº„É†
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); if(phase !== 'racing') onOpenSwitch(); }} 
                                        className={`bg-gray-700 hover:bg-gray-600 p-1 rounded-full transition-colors ${phase === 'racing' ? 'opacity-50 cursor-not-allowed' : ''}`} 
                                        title="„É¢„Éº„ÉâÂàáÊõø"
                                    >ü¶Ñ</button>
                                </h1>
                                <span className="text-xs text-gray-400">RACE {raceCount}</span>
                            </div>
                        </div>
                        <div className="relative group cursor-pointer" onMouseEnter={() => setShowHistory(true)} onMouseLeave={() => setShowHistory(false)}>
                            <div className={`flex items-center gap-2 px-3 py-1 rounded-full transition-colors ${wallet < 0 ? 'bg-red-900 animate-pulse' : 'bg-gray-800'}`}>
                                <Coins className={wallet < 0 ? 'text-red-400' : 'text-yellow-400'} size={16} />
                                <span className={`font-mono font-bold text-lg ${wallet < 0 ? 'text-red-400' : ''}`}>{wallet.toLocaleString()}</span>
                                {wallet < 0 && <span className="text-xs bg-red-600 px-1 rounded text-white ml-1">ÂÄüÈáë‰∏≠</span>}
                            </div>
                            {showHistory && (
                                <div className="absolute right-0 top-full mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-2xl p-3 z-50">
                                    <h4 className="text-xs text-gray-400 font-bold mb-2 flex items-center gap-1"><Info size={12} /> ÂèéÊîØÂ±•Ê≠¥ (Áõ¥Ëøë10‰ª∂)</h4>
                                    <div className="max-h-60 overflow-y-auto history-scroll space-y-2">
                                        {resultLog.length === 0 ? <div className="text-xs text-gray-600 text-center py-4">Â±•Ê≠¥„Å™„Åó</div> : resultLog.slice(0, 10).map((log, i) => (
                                            <div key={i} className="bg-gray-800 p-2 rounded text-xs border border-gray-700">
                                                <div className="flex justify-between mb-1">
                                                    <span className="text-yellow-500">RACE {log.race}</span>
                                                    <span className="text-gray-400">{log.winner}</span>
                                                </div>
                                                <div className="flex justify-between items-end">
                                                    <span className="text-gray-500">¬•{log.betTotal} ‚Üí ¬•{log.payout}</span>
                                                    <span className={`font-bold ${log.payout-log.betTotal >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {log.payout-log.betTotal > 0 ? '+' : ''}{(log.payout-log.betTotal).toLocaleString()}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-2 pt-2 border-t border-gray-700 text-right text-xs">
                                        <div className="text-gray-400">Total Profit</div>
                                        <div className={`font-mono font-bold text-sm ${wallet - 100000 >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {wallet - 100000 > 0 ? '+' : ''}{(wallet - 100000).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto p-3 space-y-4">
                        {phase === 'betting' && (
                            <div className="bg-white rounded-xl overflow-hidden shadow-xl text-gray-800 relative">
                                <div className="bg-green-800 text-white p-2 font-bold text-center text-sm">Âá∫Ëµ∞Ë°®</div>
                                <div className="divide-y divide-gray-200">
                                    <div className="grid grid-cols-12 text-xs text-gray-500 bg-gray-50 p-2 font-bold text-center">
                                        <div className="col-span-1">Êû†</div><div className="col-span-3 text-left pl-2">È¶¨Âêç</div><div className="col-span-2">È®éÊâã</div><div className="col-span-2">ËÑöË≥™</div><div className="col-span-2">‰ΩìÈáç</div><div className="col-span-2">„Ç™„ÉÉ„Ç∫</div>
                                    </div>
                                    {horses.map(h => (
                                        <div key={h.id} className="grid grid-cols-12 items-center p-2 text-sm hover:bg-yellow-50 relative group" onMouseEnter={() => setHoveredHorse(h)} onMouseLeave={() => setHoveredHorse(null)}>
                                            <div className="col-span-1 flex justify-center"><span className="w-6 h-6 rounded flex items-center justify-center font-bold text-xs" style={{ backgroundColor: ['white','black','#e53935','#1e88e5','#fdd835','#43a047','#fb8c00','#f48fb1'][h.id%8], color: [0,4,7].includes(h.id%8)?'black':'white', border: h.id===0?'1px solid #ccc':'none' }}>{h.number}</span></div>
                                            <div className="col-span-3 pl-2 font-bold text-gray-800 truncate">{h.name}</div>
                                            <div className="col-span-2 text-center text-xs">{h.jockey} <span className="text-[10px] bg-gray-200 px-1 rounded">{h.jockeyRank}</span></div>
                                            <div className="col-span-2 text-center text-xs"><span className="px-1 bg-gray-200 rounded">{h.style.label}</span></div>
                                            <div className="col-span-2 text-center text-xs">{h.weight} <span className={h.weightDiff>0?'text-red-500':h.weightDiff<0?'text-blue-500':'text-gray-400'}>({h.weightDiff>0?'+':''}{h.weightDiff})</span></div>
                                            <div className="col-span-2 text-right font-bold text-red-600 pr-2">{h.odds}</div>
                                        </div>
                                    ))}
                                </div>
                                {hoveredHorse && (
                                    <div 
                                        className="fixed z-50 bg-black/90 text-white p-3 rounded-lg shadow-2xl text-xs pointer-events-none w-48 border border-white/20 backdrop-blur-sm animate-in fade-in zoom-in-95 duration-100"
                                        style={{ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}
                                    >
                                        <div className="font-bold text-yellow-400 text-sm mb-2 border-b border-white/20 pb-1">{hoveredHorse.name}</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <div className="text-gray-400">ÂâçËµ∞È†Ü‰Ωç</div>
                                                <div className="font-bold text-lg">{hoveredHorse.prevRank}ÁùÄ</div>
                                            </div>
                                            <div>
                                                <div className="text-gray-400">ÂâçËµ∞‰ΩìÈáç</div>
                                                <div className="font-bold">{hoveredHorse.weight - hoveredHorse.weightDiff}kg</div>
                                            </div>
                                            <div className="col-span-2 mt-1">
                                                <div className="text-gray-400">Áä∂ÊÖã</div>
                                                <div className={`font-bold ${hoveredHorse.condition > 0.2 ? 'text-red-400' : hoveredHorse.condition < -0.1 ? 'text-blue-400' : 'text-green-400'}`}>
                                                    {hoveredHorse.condition > 0.2 ? 'Áµ∂Â•ΩË™ø' : hoveredHorse.condition > 0 ? 'Â•ΩË™ø' : hoveredHorse.condition > -0.1 ? 'ÊôÆÈÄö' : '‰∏çË™ø'}
                                                    {hoveredHorse.weightDiff > 6 && <span className="ml-2 text-xs bg-red-600 text-white px-1 rounded">Â§™„ÇÅ</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            
                                <div className="p-4 bg-blue-50 border-t border-gray-200">
                                    <div className="block md:hidden bg-gray-100 border-b p-2 mb-4">
                                         <select 
                                            className="w-full p-3 bg-white border border-gray-300 rounded font-bold text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value={betType}
                                            onChange={(e) => handleBetTypeChange(e.target.value)}
                                        >
                                            {Object.values(BET_TYPES).map(type => (
                                                <option key={type.id} value={type.id}>
                                                    {type.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="hidden md:flex bg-gray-100 border-b mb-4 overflow-x-auto">
                                        {Object.values(BET_TYPES).map(t => <button key={t.id} onClick={() => { setBetType(t.id); setSelectedHorses([null,null,null]); }} className={`flex-1 py-2 px-4 text-xs font-bold whitespace-nowrap ${betType===t.id?'bg-blue-600 text-white':'text-gray-600 hover:bg-gray-200'}`}>{t.name}</button>)}
                                    </div>

                                    <div className="bg-blue-100 text-blue-800 text-sm p-2 rounded mb-4 border border-blue-200 flex items-center gap-2">
                                        <Info size={16} />
                                        <span>{BET_TYPES[betType].desc}</span>
                                    </div>

                                    <div className="mb-4 space-y-2">
                                        {[...Array(BET_TYPES[betType].count)].map((_, i) => (
                                            <div key={i} className="flex items-center gap-2"><span className="text-xs font-bold w-12">{i===0?'1È†≠ÁõÆ':i===1?'2È†≠ÁõÆ':'3È†≠ÁõÆ'}</span>
                                                <select className="flex-1 p-2 border rounded text-sm" value={selectedHorses[i]??''} onChange={e=> {const n=[...selectedHorses]; n[i]=e.target.value===''?null:parseInt(e.target.value); setSelectedHorses(n);}}>
                                                    <option value="">ÈÅ∏Êäû</option>{horses.map((h, idx) => <option key={h.id} value={idx} disabled={selectedHorses.includes(idx) && selectedHorses[i]!==idx}>{h.number}.{h.name} ({h.odds})</option>)}
                                                </select>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center bg-white p-3 rounded border">
                                        <div className="text-2xl font-bold text-red-600 font-mono">{calculateComboOdds(betType, selectedHorses.slice(0, BET_TYPES[betType].count).map(i=>i!==null?horses[i]?.id:undefined), horses) || "---"} <span className="text-xs text-gray-500">ÂÄç</span></div>
                                        <div className="flex items-center gap-2"><input type="number" step="100" className="w-20 p-1 border rounded text-right font-bold" value={betAmount} onChange={e=>setBetAmount(e.target.value)} /><button onClick={addToSlip} className="bg-orange-500 text-white font-bold py-1 px-4 rounded text-sm">+ËøΩÂä†</button></div>
                                    </div>
                                </div>

                                {/* Bet Slip List (Betting Phase) */}
                                {betSlip.length > 0 && (
                                    <div className="bg-gray-800 p-4 text-white">
                                        <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                                            <Ticket size={16} /> ÊäïÁ•®Ê∏à„Åø„ÉÅ„Ç±„ÉÉ„Éà
                                        </h3>
                                        <div className="space-y-2 mb-4">
                                            {/* ‚òÖ‰øÆÊ≠£: onDelete„ÇíÂÆüË£Ö„Åó„ÄÅreadOnly„Çífalse„Å´Â§âÊõ¥ */}
                                            {betSlip.map(b => (
                                                <BettingTicket key={b.id} bet={b} onDelete={(id) => setBetSlip(betSlip.filter(ticket => ticket.id !== id))} isResult={false} hit={null} readOnly={false} />
                                            ))}
                                        </div>
                                        <div className="mt-4 flex justify-between items-center border-t border-gray-600 pt-2">
                                            <span className="font-bold">ÂêàË®à: {betSlip.reduce((s,b)=>s+b.amount,0).toLocaleString()}ÂÜÜ</span>
                                            <button onClick={startRace} className="bg-red-600 px-6 py-2 rounded-full font-bold animate-pulse hover:bg-red-500 flex items-center gap-2">
                                                <TrendingUp size={20} />
                                                ÊäïÁ•®„Åó„Å¶ÈñãÂßã
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {showTipster && phase === 'betting' && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
                                <div className="bg-white rounded-xl w-full max-w-sm overflow-hidden text-gray-800">
                                    <div className="bg-purple-600 text-white p-3 flex justify-between items-center font-bold"><span>‰∫àÊÉ≥Â±ã</span><button onClick={()=>setShowTipster(false)}>&times;</button></div>
                                    <div className="p-4 space-y-4">
                                        <div><label className="text-xs font-bold">‰∫àÁÆó</label><input type="number" className="w-full border p-2 rounded" value={tipsterBudget} onChange={e=>setTipsterBudget(e.target.value)} /></div>
                                        <div className="space-y-2">{Object.values(TIPSTER_COURSES).map(c=><div key={c.id} onClick={()=>setTipsterCourse(c.id)} className={`p-2 border rounded cursor-pointer text-xs ${tipsterCourse===c.id?'bg-purple-50 border-purple-500':''}`}><div className="font-bold">{c.name}</div><div>{c.desc}</div></div>)}</div>
                                        <button onClick={purchaseTipster} className="w-full bg-purple-600 text-white font-bold py-2 rounded">Ë≥ºÂÖ•</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {phase === 'betting' && <button onClick={()=>setShowTipster(true)} className="fixed bottom-6 right-6 bg-purple-600 text-white p-4 rounded-full shadow-2xl z-40 text-2xl animate-bounce">üßô‚Äç‚ôÇÔ∏è</button>}

                        {phase === 'fanfare' && <div className="flex flex-col items-center justify-center h-64 bg-black/80 rounded-xl border-4 border-yellow-500 animate-in fade-in zoom-in duration-500"><div className="text-yellow-400 text-6xl mb-4 animate-bounce">üé∫</div><h2 className="text-4xl font-black text-white tracking-widest animate-pulse">G1 FANFARE</h2><p className="text-gray-300 mt-4 text-sm">„Åæ„ÇÇ„Å™„Åè„Ç≤„Éº„Éà„ÅåÈñã„Åç„Åæ„Åô...</p></div>}

                        {phase === 'racing' && (
                            <div className="space-y-4">
                                <div className="bg-black text-yellow-400 font-bold text-center py-2 rounded-t-xl border-x-4 border-t-4 border-yellow-700 text-xl tracking-wider">{commentary}</div>
                                <div className="relative w-full aspect-[2/1] bg-green-800 rounded-xl overflow-hidden shadow-inner border-4 border-yellow-700">
                                    <div className="absolute inset-0 grass-pattern-normal opacity-50"></div>
                                    <svg className="absolute inset-0 w-full h-full" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid meet">
                                        <path d="M 200 100 L 800 100 A 150 150 0 1 1 800 400 L 200 400 A 150 150 0 1 1 200 100 Z" fill="none" stroke="#eab308" strokeWidth="120" strokeOpacity="0.2" />
                                        <path d="M 200 100 L 800 100 A 150 150 0 1 1 800 400 L 200 400 A 150 150 0 1 1 200 100 Z" fill="none" stroke="white" strokeWidth="2" strokeDasharray="20,20" />
                                        <line x1="800" y1="60" x2="800" y2="140" stroke="white" strokeWidth="8" />
                                        <text x="810" y="130" fill="white" fontSize="20" fontWeight="bold">GOAL</text>
                                        <text x="810" y="90" fill="white" fontSize="16" opacity="0.7">START</text>
                                    </svg>
                                    {horses.map(h => {
                                        const p = raceProgress.find(pr => pr.id === h.id); if(!p) return null;
                                        const getPos = (d, l) => { 
                                            const trackL=600, trackR=150, perim=trackL*2+Math.PI*trackR*2, startOff=600-(2142%perim); let dist=(d+(startOff<0?startOff+perim:startOff))%perim;
                                            const r=trackR+(l-3.5)*12; 
                                            if(dist<600) return {x:200+(600*(dist/600)), y:100-(l-3.5)*12}; 
                                            if(dist<600+Math.PI*trackR) {const th=0.5*Math.PI-((dist-600)/(Math.PI*trackR))*Math.PI; return {x:800+r*Math.cos(th), y:250-r*Math.sin(th)};} 
                                            if(dist<1200+Math.PI*trackR) return {x:800-(dist-(600+Math.PI*trackR)), y:400+(l-3.5)*12}; 
                                            const th=1.5*Math.PI-((dist-(1200+Math.PI*trackR))/(Math.PI*trackR))*Math.PI; return {x:200+r*Math.cos(th), y:250-r*Math.sin(th)}; 
                                        };
                                        const pos = getPos(p.dist, h.id);

                                        let statusEffect = "";
                                        if (p.status === 'late_start') statusEffect = "opacity-50"; 
                                        if (p.status === 'kakari') statusEffect = "animate-pulse brightness-150"; 
                                        if (p.status === 'tired') statusEffect = "grayscale";

                                        return <div key={h.id} className={`absolute flex flex-col items-center justify-center transition-transform duration-100 will-change-transform ${statusEffect}`} style={{left:`${pos.x/10}%`, top:`${pos.y/5}%`, width:'4%', height:'10%', transform:'translate(-50%,-50%)', zIndex:Math.floor(p.dist)}}>
                                            <div className="text-2xl filter drop-shadow-md horse-gallop">üê¥</div>
                                            <div className="text-[8px] px-1 rounded -mt-1 font-bold whitespace-nowrap" style={{backgroundColor:['white','black','#e53935','#1e88e5','#fdd835','#43a047','#fb8c00','#f48fb1'][h.id%8], color:[0,4,7].includes(h.id%8)?'black':'white'}}>{h.number}.{h.name}</div>
                                            
                                            {p.status === 'late_start' && <div className="absolute -top-4 text-xs font-bold text-red-500 bg-white px-1 rounded border border-red-500">ÈÅÖ</div>}
                                            {p.status === 'kakari' && <div className="absolute -top-4 text-xs font-bold text-yellow-500 bg-black px-1 rounded border border-yellow-400">Êéõ</div>}
                                            {p.status === 'tired' && <div className="absolute -top-4 text-xs font-bold text-blue-300 bg-black px-1 rounded border border-blue-300">„Éê„ÉÜ</div>}
                                        </div>
                                    })}
                                </div>
                                <div className="bg-black/80 text-white p-3 rounded-b-xl backdrop-blur">
                                    <div className="flex items-center gap-2 text-xs overflow-x-auto pb-1">
                                        <span className="bg-red-600 px-2 rounded font-bold whitespace-nowrap">ÂÖàÈ†≠</span>
                                        {raceRanking.map((h, i) => (
                                            <div key={h.id} className={`flex items-center gap-1 px-2 py-1 rounded shrink-0 ${h.rank ? 'bg-yellow-600 border border-yellow-300' : 'bg-gray-800'}`}>
                                                <span className={`font-bold ${h.rank ? 'text-white' : 'text-yellow-400'}`}>{h.rank ? `${h.rank}ÁùÄ` : i+1}</span>
                                                <span className={`w-4 h-4 rounded text-[10px] flex items-center justify-center bg-white text-black font-bold`}>{h.number}</span>
                                                <span>{h.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {betSlip.length > 0 && (
                                    <div className="mt-4">
                                        <h3 className="text-white font-bold mb-2 flex items-center gap-2 text-sm px-2">
                                            <Ticket size={16} /> Ë≥ºÂÖ•„Åó„ÅüÈ¶¨Âà∏
                                        </h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 px-2">
                                            {betSlip.map(bet => (
                                                <BettingTicket key={bet.id} bet={bet} onDelete={() => {}} isResult={false} hit={null} readOnly={true} />
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {phase === 'result' && finalResult && (
                            <div className="bg-white text-gray-900 rounded-xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-300 border-4 border-yellow-400">
                                <div className="bg-yellow-400 p-4 text-center">
                                    <h2 className="text-2xl font-black text-yellow-900">RESULT</h2>
                                </div>
                                <div className="p-4">
                                    <div className="bg-gray-100 rounded-lg p-3 mb-6">
                                        <div className="grid grid-cols-12 text-xs text-gray-500 font-bold border-b pb-2 mb-2">
                                            <div className="col-span-2 text-center">ÁùÄÈ†Ü</div>
                                            <div className="col-span-5 pl-1">È¶¨Âêç</div>
                                            <div className="col-span-2 text-center">ËÑöË≥™</div>
                                            <div className="col-span-3 text-right pr-2">„Ç™„ÉÉ„Ç∫</div>
                                        </div>
                                        <div className="space-y-2">
                                            {finalResult.map((h, i) => (
                                                <div key={h.id} className={`grid grid-cols-12 items-center text-sm p-1 rounded ${i===0 ? 'bg-yellow-200 font-bold' : i===1?'bg-gray-200':i===2?'bg-orange-100':''}`}>
                                                    <div className="col-span-2 text-center">
                                                        <span className={`inline-block w-6 h-6 rounded-full leading-6 ${i===0?'bg-yellow-500 text-white':i===1?'bg-gray-400 text-white':i===2?'bg-orange-400 text-white':'text-gray-500'}`} style={{ backgroundColor: ['white','black','#e53935','#1e88e5','#fdd835','#43a047','#fb8c00','#f48fb1'][i%8], color: [0,4,7].includes(i%8)?'black':'white', border: i===0?'1px solid #ccc':'none' }}>{i+1}</span>
                                                    </div>
                                                    <div className="col-span-5 flex items-center gap-1 pl-1">
                                                        <span className={`w-4 h-4 rounded text-[10px] flex items-center justify-center bg-gray-800 text-white font-bold`}>{h.number}</span>
                                                        <span className="truncate">{h.name}</span>
                                                    </div>
                                                    <div className="col-span-2 text-center text-xs text-gray-500">{h.style.label}</div>
                                                    <div className="col-span-3 text-right font-mono text-red-600 pr-2">{h.odds}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                
                                    {betSlip.length > 0 && (
                                        <div className="mb-6">
                                            <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2 text-sm">
                                                <Ticket size={16} /> „ÅÇ„Å™„Åü„ÅÆÊäïÁ•®ÁµêÊûú
                                            </h3>
                                            <div className="space-y-2">
                                                {betSlip.map(bet => (
                                                    <BettingTicket 
                                                        key={bet.id} 
                                                        bet={bet} 
                                                        isResult={true}
                                                        hit={checkWin(bet, finalResult)}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="text-center border-t pt-4">
                                        <div className="text-gray-500 mb-1 text-sm">‰ªäÂõû„ÅÆÂèéÊîØ</div>
                                        <div className={`text-4xl font-black font-mono ${(resultLog[0]?.payout-resultLog[0]?.betTotal)>=0?'text-green-600':'text-red-600'}`}>{((resultLog[0]?.payout-resultLog[0]?.betTotal)>=0?'+':'') + (resultLog[0]?.payout-resultLog[0]?.betTotal).toLocaleString()}</div>
                                        <div className="text-xs sm:text-sm text-gray-500 font-bold mt-1">
                                            (ÊâïÊàªÔºö{resultLog[0]?.payout.toLocaleString()}„ÄÅÈ¶¨Âà∏Ë≥ºÂÖ•Ôºö-{resultLog[0]?.betTotal.toLocaleString()})
                                        </div>
                                        <button onClick={() => { setRaceCount(c=>c+1); }} className="mt-4 bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-500 transition-transform hover:scale-105 flex items-center justify-center gap-2 mx-auto"><RotateCcw size={20} /> Ê¨°„ÅÆ„É¨„Éº„Çπ„Å∏</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };


        // ============================================================================================
        //  MODE: KIRAKIRA (KIRA„Éë„É¨„Éº„Éâ)
        // ============================================================================================
        const KirakiraMode = ({ wallet, setWallet, raceCount, setRaceCount, resultLog, setResultLog, onOpenSwitch }) => {
            const RACE_TOTAL_DISTANCE = 2142;
            const HORSE_NAMES_PREFIX = ["„Ç∑„É•„Ç¨„Éº", "„Éâ„É™„Éº„Éü„Éº", "„Éî„É≥„ÇØ", "„Çπ„Ç§„Éº„Éà", "„É©„Éñ„É™„Éº", "„Éû„Ç∑„É•„Éû„É≠", "„Éü„É´„Ç≠„Éº", "„Éï„É≠„Éº„É©„É´", "„É™„Éú„É≥", "„Ç≠„É£„É≥„Éá„Ç£", "„É°„É≠„Éá„Ç£", "„Ç≠„É©„Ç≠„É©", "„Çπ„Çø„Éº", "„É´„Éä", "„ÇΩ„É©", "„Éè„Éº„Éà", "„Éï„Çß„Ç¢„É™„Éº", "„Éó„É™„Ç∫„É†", "„Éõ„Ç§„ÉÉ„Éó", "„Éû„Ç´„É≠„É≥", "„Éü„É≥„Éà", "„Éç„Ç™„É≥", "„Éù„ÉÉ„Éó"];
            const HORSE_NAMES_SUFFIX = ["„É¶„Éã„Ç≥„Éº„É≥", "„Éê„Éã„Éº", "„Ç≠„É£„ÉÉ„Éà", "„Éâ„É©„Ç¥„É≥", "„Éö„Ç¨„Çµ„Çπ", "„Ç≠„ÉÜ„Ç£", "„Éô„Ç¢", "„Ç®„É≥„Ç∏„Çß„É´", "„Éó„É™„É≥„Çª„Çπ", "„Éâ„Éº„É´", "„Ç≠„É£„É≥„Éá„Ç£", "„Éâ„É™„Éº„É†", "„É†„Éº„É≥", "„Çµ„É≥", "„Çπ„Éé„Éº", "„Çπ„Ç§„Éº„ÉÑ", "„Éà„Ç•„Ç§„É≥„ÇØ„É´", "„Éû„Éº„É°„Ç§„Éâ", "„Çπ„Çø„Éº„É©„Ç§„Éà", "„ÉÜ„Ç£„Ç¢„É©"];
            const JOCKEYS = [{ name: "„Ç∑„É•„Ç¨„Éº‚òÜ„É©„Ç§„ÉÄ„Éº", weight: 10, rank: "S" }, { name: "„É©„Éñ„É™„Éº„Éª„Éâ„É≠„ÉÉ„Éó", weight: 10, rank: "S" }, { name: "„Éü„É´„ÇØ„ÉÜ„Ç£„Éº„Éª„Éó„É™„É≥", weight: 9, rank: "A" }, { name: "„Ç≠„É£„É≥„Éá„Ç£„Éª„Éù„ÉÉ„Éó", weight: 9, rank: "A" }, { name: "„Ç≠„É©„É™„Çì", weight: 8, rank: "A" }, { name: "„Éè„Éº„Éà„Éï„É´„ÅÜ„Åï„Åé", weight: 8, rank: "A" }, { name: "„Éï„Çß„Ç¢„É™„Éº‚òÜ„Éü„É≥„Éà", weight: 8, rank: "A" }, { name: "„É™„Éú„É≥„Éª„Çπ„Çø„Éº", weight: 8, rank: "A" }, { name: "„Éû„Ç´„É≠„É≥„Éª„Çπ„Ç´„Ç§", weight: 7, rank: "B" }, { name: "„Éî„Éº„ÉÅ„Åè„Åæ„Åì", weight: 7, rank: "B" }, { name: "„É´„Éä„ÉÜ„Ç£„ÉÉ„ÇØ„Å≠„Åì", weight: 7, rank: "B" }, { name: "„ÇΩ„Éº„ÉÄ„Éª„Éï„É≠„Éº„Éà", weight: 6, rank: "C" }, { name: "„Éù„ÉÉ„Éó„Ç≥„Éº„É≥‚òÖ„Åª„Åó", weight: 6, rank: "C" }, { name: "„Éõ„Ç§„ÉÉ„Éó„Éª„ÇØ„É©„Ç¶„Éâ", weight: 5, rank: "C" }, { name: "„ÉÅ„Éß„Ç≥„ÉÅ„ÉÉ„Éó", weight: 5, rank: "C" }, { name: "„Éâ„É™„Éº„É†‚òÜ„Å≤„Åã„Çä", weight: 4, rank: "D" }, { name: "„Çπ„É§„Çπ„É§„Å≠„ÇÄ„Çä", weight: 3, rank: "D" }];
            const RUNNING_STYLES = [{ id: 0, name: "„Åç„Çâ„Åç„Çâ„ÉÄ„ÉÉ„Ç∑„É•", label: "‚ú®ÂÖà", desc: "„ÅØ„Åò„Åæ„Çä„Åã„Çâ„Ç≠„É©„Ç≠„É©ÂÖ®Èñã„ÅßÈ£õ„Å≥Âá∫„Åô" }, { id: 1, name: "„Åµ„Çì„Çè„ÇäÂÖàÈ†≠", label: "‚ô¨Ââç", desc: "„Åã„Çè„ÅÑ„ÅèÂâç„ÅÆ„Åª„ÅÜ„ÅßÊßòÂ≠êË¶ã„Åó„Å™„Åå„ÇâÈÄ≤„ÇÄ" }, { id: 2, name: "„Åù„ÇàÈ¢®„Åä„ÅÑ„Åã„Åë", label: "‚òÅ‰∏≠", desc: "‰∏≠Âõ£„Åã„Çâ„Åù„Å£„Å®ËøΩ„ÅÑ‰∏ä„Åí„Çã„Çπ„Çø„Ç§„É´" }, { id: 3, name: "„Å©„Åç„Å©„Åç„É©„Çπ„Éà„Çπ„Éë„Éº„Éà", label: "üí´Âæå", desc: "ÊúÄÂæå„Å´„Å©„Åç„Å©„Åç‰∏ÄÊ∞ó„Å´„Åæ„Åè„Çã„Çà" }];
            const BET_TYPES = { WIN: { id: 'WIN', name: '„ÅÑ„Å°„Å∞„ÇìÊòü„ÉÅ„É£„É≥„Çπ', count: 1, desc: '„ÅÑ„Å°„Å∞„Çì„Å´„Ç¥„Éº„É´„Åô„Çã„Åä„Å®„ÇÇ„Å†„Å°„Çí„ÅÇ„Å¶„Çã„Çà' }, PLACE: { id: 'PLACE', name: '„Åï„Çì„Å∞„ÇìÊòü„ÉÅ„É£„É≥„Çπ', count: 1, desc: '‰∏ä‰Ωç3ÁùÄ„ÅÆ„Å©„Åì„Åã„Å´ÂÖ•„Çã„Åä„Å®„ÇÇ„Å†„Å°„Çí„ÅÇ„Å¶„Çã„ÄÅ„Å°„Çá„Å£„Å®„ÇÑ„Åï„Åó„ÇÅ„ÉÅ„É£„É≥„Çπ' }, QUINELLA: { id: 'QUINELLA', name: '„Åç„Çâ„Åç„Çâ„Éö„Ç¢', count: 2, desc: '1„Éª2ÁùÄ„Å´„Å™„Çã„Å™„Åã„Çà„Åó„Éö„Ç¢„ÇíÂΩì„Å¶„Çã„ÇàÔºÅÔºàÈ†Ü‰∏çÂêåÔºâ' }, WIDE: { id: 'WIDE', name: '„Å™„Åã„Çà„Åó„Ç¥„Éº„É´', count: 2, desc: '3ÁùÄ‰ª•ÂÜÖ„Å´ÂÖ•„Çã„Å™„Åã„Çà„Åó„ÅÆ„Åä„Å®„ÇÇ„Å†„Å°„Éö„Ç¢„Çí„Åà„Çâ„Å∂„ÇàÔºÅÔºàÈ†Ü‰∏çÂêåÔºâ' }, EXACTA: { id: 'EXACTA', name: '„Å™„Çâ„Çì„Åß„Ç¥„Éº„É´', count: 2, desc: '1ÁùÄ„Å®2ÁùÄ„Çí„Å™„Çâ„Å≥È†Ü„Åæ„Åß„Å¥„Å£„Åü„ÇäÂΩì„Å¶„Çã„ÇàÔºÅ' }, TRIO: { id: 'TRIO', name: '„Åç„Çâ„Åç„Çâ„Éà„É™„Ç™', count: 3, desc: '1„Äú3ÁùÄ„Å´„Å™„Çã„Éà„É™„Ç™„ÇíÂΩì„Å¶„ÇãÔºàÈ†Ü‰∏çÂêåÔºâ' }, TRIFECTA: { id: 'TRIFECTA', name: '„ÇÜ„ÇÅ„Åø„Çã„Éà„É™„Éó„É´', count: 3, desc: '1„Äú3ÁùÄ„Çí„Å™„Çâ„Å≥È†Ü„Åæ„Åß„Å¥„Å£„Åü„ÇäÂΩì„Å¶„Çã„Éâ„É™„Éº„É†„ÉÅ„É£„É≥„ÇπÔºÅ' }};
            const TIPSTER_COURSES = { SOLID: { id: 'SOLID', name: '„Åª„Å£„Åì„Çä„Ç≥„Éº„Çπ', desc: 'ÂΩì„Åü„Çä„ÇÑ„Åô„ÅïÈáçË¶ñ„ÅÆ„Åª„Çè„Åª„Çè„Ç≥„Éº„Çπ', type: 'PLACE' }, BALANCE:{ id: 'BALANCE',name: '„Åç„Çâ„Åç„Çâ„Ç≥„Éº„Çπ', desc: '„Å°„Çá„ÅÜ„Å©„ÅÑ„ÅÑ„Éâ„Ç≠„Éâ„Ç≠ÊÑü„ÅÆ„Åç„Çâ„Åç„Çâ„Ç≥„Éº„Çπ', type: 'QUINELLA' }, DREAM: { id: 'DREAM', name: '„ÇÜ„ÇÅ„Åø„Çã„Ç≥„Éº„Çπ', desc: '‰∏ÄÁô∫Â§ß„Åç„Åè„ÇÜ„ÇÅ„Çí„Å§„Åã„Åø„Åü„ÅÑ„ÅÇ„Å™„Åü„Å∏', type: 'TRIFECTA' }};

            const [phase, setPhase] = useState('betting');
            const [horses, setHorses] = useState([]);
            const [betType, setBetType] = useState('WIN');
            const [selectedHorses, setSelectedHorses] = useState([null, null, null]);
            const [betAmount, setBetAmount] = useState(1000);
            const [betSlip, setBetSlip] = useState([]);
            const [raceProgress, setRaceProgress] = useState([]);
            const [raceTime, setRaceTime] = useState(0);
            const [raceRanking, setRaceRanking] = useState([]);
            const [finalResult, setFinalResult] = useState(null);
            const [commentary, setCommentary] = useState("„Åä„Å®„ÇÇ„Å†„Å°„Åå„Éë„É¨„Éº„Éâ„ÅÆÊ∫ñÂÇô‰∏≠‚Ä¶");
            const [showHistory, setShowHistory] = useState(false);
            const [hoveredHorse, setHoveredHorse] = useState(null);
            const [showTipster, setShowTipster] = useState(false);
            const [tipsterBudget, setTipsterBudget] = useState(1000);
            const [tipsterCourse, setTipsterCourse] = useState('SOLID');
            const animationRef = useRef(null);

            // --- Betting Ticket Component (Kirakira Mode - Restored) ---
            const BettingTicket = ({ bet, onDelete, isResult, hit, readOnly }) => (
                <div
                    className={`bg-white border-2 ${isResult
                            ? (hit ? 'border-pink-400' : 'border-gray-300')
                            : (bet.isTipster ? 'border-purple-300' : 'border-pink-300')}
                        rounded-xl shadow-md relative overflow-hidden font-mono w-full mb-3 max-w-sm mx-auto transform transition ${!isResult && 'hover:scale-[1.02]'}`}
                >
                    <div
                        className={`${isResult
                                ? (hit ? 'bg-pink-400' : 'bg-gray-300')
                                : (bet.isTipster ? 'bg-gradient-to-r from-purple-400 to-pink-400' : 'bg-gradient-to-r from-pink-400 to-rose-400')}
                            text-white text-xs px-2 py-1 flex justify-between items-center`}
                    >
                        <span className="font-bold flex items-center gap-1">
                            {bet.isTipster ? <Sparkles size={12} /> : <Ticket size={12} />}
                            {bet.isTipster ? '„ÇÜ„ÇÅ‰∫àÊÉ≥„Çµ„É≠„É≥' : 'KIRA„Éë„É¨„Éº„Éâ'}
                        </span>
                        <span>{new Date(bet.id).toLocaleTimeString()} Áô∫Ë°å</span>
                    </div>

                    <div className="p-3 text-pink-900 ticket-pattern-kirakira relative">
                        <div className="flex justify-between items-end border-b-2 border-dashed border-pink-200 pb-2 mb-2">
                            <div>
                                <div className="text-[10px] text-pink-400 font-bold mb-1">{bet.typeName}</div>
                                <div className="text-2xl font-black tracking-widest">
                                    {bet.selection.map(h => h.number).join(bet.type === 'TRIFECTA' ? ' ‚Üí ' : ' & ')}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-pink-300">„Åç„Çâ„Åç„ÇâÂÄçÁéá</div>
                                <div className="text-lg font-bold text-rose-500">{bet.odds}ÂÄç</div>
                            </div>
                        </div>

                        <div className="flex justify-between items-center">
                            <div className="text-sm font-bold">
                                {bet.amount.toLocaleString()}„Ç∏„É•„Ç®„É´
                            </div>
                            {!isResult && !readOnly && (
                                <button
                                    onClick={() => onDelete(bet.id)}
                                    className="text-pink-300 hover:text-rose-400 transition-colors p-1"
                                    title="„Åì„ÅÆ„ÇÜ„ÇÅ„ÉÅ„Ç±„Çí„ÇÑ„ÇÅ„Çã"
                                >
                                    <Trash2 size={16} />
                                </button>
                            )}
                            {isResult && (
                                <div className="text-sm font-bold">
                                    {hit
                                        ? <span className="text-pink-500">„ÅÇ„Åü„Çäüíñ</span>
                                        : <span className="text-gray-400">„ÅØ„Åö„Çå‚Ä¶</span>}
                                </div>
                            )}
                        </div>

                        {isResult && hit && (
                            <div
                                className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 stamp-hit border-4 font-black text-3xl px-2 select-none pointer-events-none opacity-80">
                                YUME
                            </div>
                        )}
                        {isResult && !hit && (
                            <div
                                className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 stamp-miss border-4 font-black text-3xl px-2 select-none pointer-events-none opacity-40">
                                BOO
                            </div>
                        )}
                        {!isResult && (
                            <div
                                className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-4 ${bet.isTipster ? 'border-purple-300/40 text-purple-300/40' : 'border-pink-300/40 text-pink-300/40'} font-black text-3xl rotate-12 px-2 select-none pointer-events-none`}>
                                {bet.isTipster ? 'PRO' : 'YUME'}
                            </div>
                        )}
                    </div>
                </div>
            );

            const calculateComboOdds = (type, horseIndices, horses) => {
                if (!horseIndices.every(idx => idx !== null && idx !== undefined)) return 0;
                const probs = horseIndices.map(idx => 1 / horses[idx].odds); 
                let jointProb = 1;
                if (type === 'WIN') jointProb = probs[0];
                else if (type === 'PLACE') jointProb = probs[0] * 3.0;
                else if (type === 'QUINELLA') jointProb = probs[0] * probs[1] * 2.5; 
                else if (type === 'WIDE') jointProb = probs[0] * probs[1] * 4.5; 
                else if (type === 'EXACTA') jointProb = probs[0] * probs[1] * 1.2;
                else if (type === 'TRIO') jointProb = probs[0] * probs[1] * probs[2] * 7.0; 
                else if (type === 'TRIFECTA') jointProb = probs[0] * probs[1] * probs[2] * 1.5; 
                let odds = (1 / jointProb) * 0.75; 
                if (type !== 'WIN' && odds < 1.1) odds = 1.1;
                if (type === 'PLACE' && odds < 1.0) odds = 1.0; 
                return Math.min(99999.9, Math.max(1.0, parseFloat(odds.toFixed(1))));
            };
            const checkWin = (bet, finishOrder) => {
                if (!finishOrder || finishOrder.length < 3) return false;
                const ids = bet.selection.map(h => h.id);
                const r1 = finishOrder[0].id; const r2 = finishOrder[1].id; const r3 = finishOrder[2].id;
                if (bet.type === 'WIN') return ids[0] === r1;
                else if (bet.type === 'PLACE') return ids[0] === r1 || ids[0] === r2 || ids[0] === r3;
                else if (bet.type === 'QUINELLA') { const top2 = [r1, r2]; return top2.includes(ids[0]) && top2.includes(ids[1]); }
                else if (bet.type === 'WIDE') { const top3 = [r1, r2, r3]; return top3.includes(ids[0]) && top3.includes(ids[1]); }
                else if (bet.type === 'EXACTA') return ids[0] === r1 && ids[1] === r2;
                else if (bet.type === 'TRIO') { const top3 = [r1, r2, r3].sort().join(','); const sel = [...ids].sort().join(','); return top3 === sel; }
                else if (bet.type === 'TRIFECTA') return ids[0] === r1 && ids[1] === r2 && ids[2] === r3;
                return false;
            };

            const setupRace = () => {
                const numHorses = 8; const newHorses = []; let totalPopularityScore = 0; const usedNames = new Set(); const usedJockeys = new Set(); let strengthPool = [];
                const racePattern = Math.random(); let patternName = "";
                if (racePattern < 0.3) { patternName = "„Å®„Åè„Åπ„Å§„Çπ„Çø„Éº"; strengthPool.push(95 + Math.random() * 10); for(let k=0; k<7; k++) strengthPool.push(65 + Math.random() * 25); } 
                else if (racePattern < 0.6) { patternName = "„ÉÄ„Éñ„É´„Çπ„Çø„Éº"; strengthPool.push(90 + Math.random() * 8); strengthPool.push(90 + Math.random() * 8); for(let k=0; k<6; k++) strengthPool.push(65 + Math.random() * 25); } 
                else if (racePattern < 0.8) { patternName = "„Éà„É™„Éó„É´„Çπ„Çø„Éº"; for(let k=0; k<3; k++) strengthPool.push(85 + Math.random() * 10); for(let k=0; k<5; k++) strengthPool.push(65 + Math.random() * 25); } 
                else { patternName = "„Åø„Çì„Å™‰∏ªÂΩπ"; const baseStrength = 60 + Math.random() * 10; for(let k=0; k<8; k++) strengthPool.push(baseStrength + (Math.random() - 0.5) * 20); }
                strengthPool.sort(() => Math.random() - 0.5);

                for (let i = 0; i < numHorses; i++) {
                    const strength = Math.max(20, Math.min(120, strengthPool[i]));
                    let name = HORSE_NAMES_PREFIX[Math.floor(Math.random() * HORSE_NAMES_PREFIX.length)] + HORSE_NAMES_SUFFIX[Math.floor(Math.random() * HORSE_NAMES_SUFFIX.length)];
                    while(usedNames.has(name)) { name = HORSE_NAMES_PREFIX[Math.floor(Math.random() * HORSE_NAMES_PREFIX.length)] + HORSE_NAMES_SUFFIX[Math.floor(Math.random() * HORSE_NAMES_SUFFIX.length)]; }
                    usedNames.add(name);
                    let jockey = JOCKEYS[Math.floor(Math.random() * JOCKEYS.length)];
                    while(usedJockeys.has(jockey.name)) { jockey = JOCKEYS[Math.floor(Math.random() * JOCKEYS.length)]; }
                    usedJockeys.add(jockey.name);
                    const perfBase = 120 - strength + (Math.random() * 30 - 15); 
                    let prevRank = perfBase < 30 ? 1 : perfBase < 40 ? 2 : perfBase < 50 ? 3 : perfBase < 60 ? 4 : perfBase < 80 ? Math.floor(Math.random()*2)+5 : Math.floor(Math.random()*2)+7; if(prevRank > 8) prevRank = 8;
                    const baseWeight = 460 + Math.floor(Math.random() * 80); const weightDiff = Math.floor(Math.random() * 16) - 8;
                    const r = Math.random(); let avatar = "ü¶Ñ"; if (r < 0.15) avatar = "üê∞"; else if (r < 0.30) avatar = "üê±"; else if (r < 0.45) avatar = "üêª";
                    newHorses.push({ id: i, number: i + 1, name, avatar, jockey: jockey.name, jockeyWeight: jockey.weight, jockeyRank: jockey.rank, strength, stamina: Math.random() * 0.4 + 0.8, style: RUNNING_STYLES[Math.floor(Math.random() * RUNNING_STYLES.length)], condition: (Math.random() * 0.6) - 0.3, prevRank, weight: baseWeight + weightDiff, weightDiff, odds: 0 });
                }
                newHorses.forEach(h => {
                    let rankScore = h.prevRank === 1 ? 100 : h.prevRank === 2 ? 80 : h.prevRank === 3 ? 60 : h.prevRank <= 5 ? 40 : 20;
                    h.popularity = Math.pow(rankScore + (h.jockeyWeight * 3) + ((h.strength * 0.4) + (h.condition * 20) + (Math.random() * 10)), 2.5);
                    totalPopularityScore += h.popularity;
                });
                newHorses.forEach(horse => {
                    let rawOdds = (1 / (horse.popularity / totalPopularityScore)) * 0.8; 
                    if (rawOdds < 1.1) rawOdds = 1.1; if (rawOdds > 300.0) rawOdds = 300.0 + (Math.random() * 200); 
                    horse.odds = parseFloat(rawOdds.toFixed(1));
                });

                if (Math.random() < 0.08) {
                    const darkHorses = newHorses.filter(h => h.odds >= 15.0);
                    if (darkHorses.length > 0) {
                        const buffedHorse = darkHorses[Math.floor(Math.random() * darkHorses.length)];
                        buffedHorse.condition = 0.3; 
                        buffedHorse.strength += 8;  
                    }
                }

                setHorses(newHorses); setBetSlip([]); setRaceProgress(newHorses.map(h => ({ id: h.id, dist: 0, speed: 0, fatigue: 0, rank: null, status: 'normal', maxSpeed: (h.strength / 100) + 0.8 })));
                setFinalResult(null); setPhase('betting'); setCommentary(`Á¨¨${raceCount}„Åç„Çâ„Åç„Çâ„Éë„É¨„Éº„ÉâÔºà${patternName}Ôºâ„Åç„Çâ„Åç„ÇâÂèó‰ªò‰∏≠‚ô™`); setSelectedHorses([null, null, null]);
            };
            useEffect(() => setupRace(), [raceCount]);

            // ‚òÖ‰øÆÊ≠£: „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíËøΩÂä†
            useEffect(() => {
                return () => {
                    if (animationRef.current) cancelAnimationFrame(animationRef.current);
                };
            }, []);

            const purchaseTipster = () => {
                // ‚òÖ‰øÆÊ≠£: „É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÄåÂÄüÈáë„Åó„Å¶Ë≥ºÂÖ•Ôºü„Äç„Åã„Çâ„ÄåÊîØÊâï„ÅÑ„ÅØÁô∫Ëµ∞ÊôÇ„Å´„Åæ„Å®„ÇÅ„Å¶ÔºàÂÄüÈáë„Å´„Å™„Çã„Åã„ÇÇÔºâ„Äç„Å´Â§âÊõ¥
                if (tipsterBudget > wallet && wallet >= 100) alert("„Ç∏„É•„Ç®„É´„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„ÇÜ„ÇÅ‰∫àÊÉ≥„ÉÅ„Ç±„ÉÉ„Éà„ÇíÁô∫Ë°å„Åó„Åæ„Åô„ÄÇ\n‰ª£Èáë„ÅØ„Éë„É¨„Éº„ÉâÈñãÂßãÊôÇ„Å´„Åæ„Å®„ÇÅ„Å¶Á≤æÁÆó„Åï„Çå„Åæ„ÅôÔºàÂÄüÈáë„Å´„Å™„Çä„Åæ„ÅôÔºâ„ÄÇ");
                else if (tipsterBudget <= 0) { alert("„Åç„Çâ„Åç„Çâ‰∫àÁÆó„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠„ÄÇ"); return; }
                
                const scoredHorses = horses.map(h => ({
                    ...h,
                    tipsterScore: (h.strength * 0.4) + (h.condition * 50) + (h.jockeyWeight * 2) + ((Math.random() - 0.5) * 30)
                })).sort((a, b) => b.tipsterScore - a.tipsterScore);

                let type='', sel=[];
                if (tipsterCourse === 'SOLID') { type = 'PLACE'; sel = [scoredHorses[0]]; } 
                else if (tipsterCourse === 'BALANCE') { type = 'QUINELLA'; sel = [scoredHorses[0], scoredHorses[1]]; } 
                else if (tipsterCourse === 'DREAM') { 
                    const darkHorses = horses.filter(h => h.odds >= 10.0).sort((a, b) => b.condition - a.condition);
                    const dark = darkHorses.length > 0 ? darkHorses[0] : scoredHorses[2];
                    sel = [scoredHorses[0], scoredHorses[1]];
                    if (sel.some(p => p.id === dark.id)) sel.push(scoredHorses[2]); else sel.push(dark);
                    type = 'TRIFECTA'; 
                }
                const newBet = { id: Date.now(), type, typeName: BET_TYPES[type].name, selection: sel, amount: parseInt(tipsterBudget), odds: calculateComboOdds(type, sel.map(s => s.id), horses), isTipster: true };
                setBetSlip(prev => [...prev, newBet]); setShowTipster(false); alert("„ÇÜ„ÇÅ‰∫àÊÉ≥„ÉÅ„Ç±„ÉÉ„Éà„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÇàÔºÅ‰∏ã„ÅÆ„É™„Çπ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Å≠„ÄÇ");
            };
            const addToSlip = () => {
                const req = BET_TYPES[betType].count; const sel = selectedHorses.slice(0, req);
                if (sel.includes(null)) { alert("„ÅÑ„Å£„Åó„Çá„Å´Ëµ∞„Å£„Å¶„Åª„Åó„ÅÑÂ≠ê„Çí„Åà„Çâ„Çì„Åß„Å≠„ÄÇ"); return; }
                if (new Set(sel).size !== sel.length) { alert("Âêå„Åò„Åä„Å®„ÇÇ„Å†„Å°„ÇíÈáç„Å≠„Å¶„Åà„Çâ„Å∂„Åì„Å®„ÅØ„Åß„Åç„Å™„ÅÑ„Çà„ÄÇ"); return; }
                if (betAmount <= 0) return;
                const newBet = { id: Date.now(), type: betType, typeName: BET_TYPES[betType].name, selection: sel.map(idx => horses[idx]), amount: parseInt(betAmount), odds: calculateComboOdds(betType, sel.map(i => horses[i].id), horses), isTipster: false };
                setBetSlip([...betSlip, newBet]);
            };
            const startRace = () => {
                const total = betSlip.reduce((s, b) => s + b.amount, 0);
                if (total === 0 && !confirm("„ÉÅ„Ç±„ÉÉ„Éà„Å™„Åó„Åß„ÄÅ„Åü„Å†Ë¶ã„Å¶Ê•Ω„Åó„ÇÄÔºü")) return;
                if (total > wallet && !confirm(`„Ç∏„É•„Ç®„É´„ÅåÂ∞ë„ÅóË∂≥„Çä„Å™„ÅÑ„Åø„Åü„ÅÑ‚Ä¶\n„Éù„Ç∑„Çß„ÉÉ„ÉàÔºö${wallet.toLocaleString()}„Ç∏„É•„Ç®„É´\n„ÇÜ„ÇÅ„ÉÅ„Ç±Ôºö${total.toLocaleString()}„Ç∏„É•„Ç®„É´\n\n„Å°„Çá„Å£„Å®„Å†„ÅëÊú™Êù•„ÅÆ„Ç∏„É•„Ç®„É´„Çí„ÅÇ„Å¶„Å´„Åó„Å¶„Éë„É¨„Éº„Éâ„Å´ÂèÇÂä†„Åó„Å°„ÇÉ„ÅÜÔºü`)) return;
                setWallet(prev => prev - total); setPhase('fanfare'); setCommentary("„Åæ„ÇÇ„Å™„Åè„Åç„Çâ„Åç„Çâ„Éë„É¨„Éº„Éâ„Åå„ÅØ„Åò„Åæ„Çä„Åæ„Åô‚Ä¶");
                setTimeout(() => setCommentary("„Éà„É©„É≥„Éö„ÉÉ„Éà„ÅÆ„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨„Åå„Å≤„Å≥„Åç„Çè„Åü„ÇãÔºÅ"), 300); setTimeout(() => setCommentary("„Åä„Å®„ÇÇ„Å†„Å°„Åå‰∏¶„Çì„Åß„ÅÑ„Åæ„Åô‚Ä¶‚Ä¶‚Ä¶"), 1800);
                setTimeout(() => { setPhase('racing'); setCommentary("„Éë„É¨„Éº„Éâ„ÄÅ„Çπ„Çø„Éº„ÉàÔºÅÔºÅ"); runRace(); }, 2500);
            };
            const runRace = () => {
                let currentProgress = horses.map(h => ({ id: h.id, dist: 0, speed: 0, fatigue: 0, rank: null, status: 'normal', maxSpeed: (h.strength / 100) + 0.8 }));
                currentProgress = currentProgress.map(p => { if (Math.random() < (10 - horses[p.id].jockeyWeight) * 0.008) p.status = 'late_start'; return p; });
                setRaceProgress(currentProgress);
                let time = 0, nextRank = 1, finishedOrder = [];
                const loop = () => {
                    time += 0.1;
                    currentProgress = currentProgress.map(p => {
                        if (p.rank !== null) return p;
                        const horse = horses.find(h => h.id === p.id);
                        let targetSpeed = p.maxSpeed * (1 + (horse.condition * 0.3) - (horse.weightDiff > 0 ? horse.weightDiff * 0.005 : 0));
                        const pct = p.dist / RACE_TOTAL_DISTANCE;
                        if (p.status === 'late_start') { targetSpeed *= 0.5; if (pct > 0.05 + Math.random() * 0.05) p.status = 'normal'; }
                        if (pct > 0.2 && pct < 0.7 && p.status === 'normal' && Math.random() < (10 - horse.jockeyWeight) * 0.0005) p.status = 'kakari';
                        if (p.status === 'kakari') { targetSpeed *= 1.15; p.fatigue += p.speed * 0.07; if (Math.random() < 0.03) p.status = 'normal'; } else p.fatigue += p.speed * 0.02 * (1.0 - horse.jockeyWeight * 0.02);
                        if (pct < 0.15) { if (horse.style.id === 0) targetSpeed *= 1.2; else if (horse.style.id === 3) targetSpeed *= 0.8; } 
                        else if (pct < 0.6) { targetSpeed *= 0.9; if (Math.random() < 0.005) targetSpeed *= 1.1; } 
                        else if (pct < 0.85) { if (horse.style.id === 1) targetSpeed *= 1.1; if (horse.style.id === 2) targetSpeed *= 1.2; } 
                        else { if (horse.style.id === 3) targetSpeed *= 1.5; else if (horse.style.id === 0) targetSpeed *= 0.8; else targetSpeed *= 1.0; 
                            if (p.fatigue > horse.strength * horse.stamina * 0.9) { targetSpeed *= (1.0 - Math.min(0.4, (p.fatigue - horse.strength * horse.stamina * 0.9) * 0.05)); p.status = 'tired'; }
                        }
                        p.speed += ((targetSpeed - p.speed) * 0.02) + (Math.random() - 0.5) * 0.3; if(p.speed < 0.2) p.speed = 0.2;
                        p.dist += p.speed;
                        if (p.dist >= RACE_TOTAL_DISTANCE) { p.dist = RACE_TOTAL_DISTANCE; p.rank = nextRank++; finishedOrder.push(horse); }
                        return p;
                    });
                    const sorted = [...currentProgress].sort((a, b) => (a.rank ?? 999) - (b.rank ?? 999) || b.dist - a.dist);
                    setRaceRanking(sorted.map(p => ({ ...horses.find(h => h.id === p.id), rank: p.rank }))); setRaceProgress([...currentProgress]); setRaceTime(time);
                    if (Math.floor(time * 10) % 50 === 0) {
                        const leader = sorted[0], pct = leader.dist / RACE_TOTAL_DISTANCE;
                        if (pct < 0.15) setCommentary(currentProgress.some(p=>p.status==='late_start') ? `„Åä„Å£„Å®ÔºÅÂá∫ÈÅÖ„Çå„ÅåÁô∫Áîü„ÄÇ` : `ÂêÑÈ¶¨„ÄÅ„Åç„Çå„ÅÑ„Å™„Çπ„Çø„Éº„Éà„ÇíÂàá„Çä„Åæ„Åó„Åü„ÄÇ`);
                        else if (pct < 0.4) setCommentary(currentProgress.some(p=>p.status==='kakari') ? `${horses[currentProgress.find(p=>p.status==='kakari').id].name}„ÄÅË°å„Åç„Åü„Åå„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ` : `${horses[leader.id].name}„Åå„Åã„Çè„ÅÑ„Åè„Éë„É¨„Éº„Éâ„Çí„Å≤„Å£„Å±„Çä„Åæ„Åô„ÄÇ`);
                        else if (pct < 0.6) setCommentary(`„É¨„Éº„Çπ„ÅØ‰∏≠Áõ§„ÄÅ${horses[leader.id].name}„ÅåÂÖàÈ†≠„Çí„Ç≠„Éº„Éó„ÄÇ`);
                        else if (pct < 0.85) setCommentary(`„Éè„Éº„Éà„ÅÆ„Ç´„Éº„Éñ„Çí„Åæ„Åå„Å£„Å¶„ÄÅ„Åø„Çì„Å™„Åß„Åµ„Çè„Å£„Å®„Åã„Åë„Åä„Çä„Å¶„ÅÑ„ÅèÔºÅ`);
                        else if (pct < 0.95) setCommentary(currentProgress.find(p=>p.status==='tired' && p.id===leader.id) ? `${horses[leader.id].name}„ÄÅ„Å°„Çá„Å£„Å®„Å§„Åã„Çå„Å¶„Åç„Åü„Åã„ÇÇ‚Ä¶ÔºÅ` : `${horses[leader.id].name}„ÄÅ„Åì„ÅÆ„Åæ„Åæ„Ç¥„Éº„É´„É™„Éú„É≥„Çí„Åç„Çã„ÅÆ„ÅãÔºÅÔºü`);
                        else if (!finalResult) setCommentary(`„Ç¥„Éº„É´„ÅÆ„Éè„Éº„Éà„Åæ„Åß„ÇÇ„ÅÜÂ∞ë„ÅóÔºÅ`);
                    }
                    if (nextRank > horses.length) { setFinalResult(finishedOrder); setPhase('result'); processResults(finishedOrder); cancelAnimationFrame(animationRef.current); } else animationRef.current = requestAnimationFrame(loop);
                };
                animationRef.current = requestAnimationFrame(loop);
            };
            const processResults = (order) => {
                setCommentary(`„ÅÑ„Å°„Å∞„Çì„Å´„Ç¥„Éº„É´„ÉÜ„Éº„Éó„Çí„Åç„Å£„Åü„ÅÆ„ÅØ‚Ä¶ ${order[0].name}ÔºÅ`); let totalPayout = 0;
                betSlip.forEach(bet => { if (checkWin(bet, order)) totalPayout += Math.floor(bet.amount * bet.odds); });
                setWallet(prev => prev + totalPayout);
                setResultLog(prev => [{ race: raceCount, winner: order[0].name, betTotal: betSlip.reduce((s, b) => s + b.amount, 0), payout: totalPayout }, ...prev]);
            };

            const handleBetTypeChange = (newType) => {
                setBetType(newType);
                setSelectedHorses([null, null, null]);
            };

            const HeartTrack = ({ horses, progress }) => {
                const START_T = 0.9;
                const heartPos = (t, laneIdx) => {
                    const cx = 500, cy = 250;
                    const scaleX = 17; 
                    const scaleY = 8;  
                    const offset = (laneIdx - 3.5) * 0.05; 
                    
                    let x0 = 16 * Math.pow(Math.sin(t), 3);
                    let y0 = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                    
                    let x = cx + x0 * scaleX;
                    let y = cy - y0 * scaleY;
                    
                    return { 
                        x: cx + (x - cx) * (1 + offset), 
                        y: cy + (y - cy) * (1 + offset) 
                    };
                };
                const pathPts = useMemo(() => { const p=[]; for(let i=0;i<=220;i++) {const {x,y}=heartPos(START_T+2*Math.PI*(i/220),3.5); p.push(`${x},${y}`);} return p.join(' '); }, []);
                const goal = useMemo(() => heartPos(START_T, 3.5), []);
                return (
                    <div className="relative w-full aspect-[2/1] bg-pink-100 rounded-3xl overflow-hidden shadow-inner border-4 border-pink-300">
                        <div className="absolute inset-0 grass-pattern-kirakira opacity-70"></div>
                        <svg className="absolute inset-0 w-full h-full" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid meet">
                            <defs><linearGradient id="tG" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stopColor="#f472b6"/><stop offset="1" stopColor="#a855f7"/></linearGradient></defs>
                            <polyline points={pathPts} fill="none" stroke="url(#tG)" strokeWidth="110" strokeLinejoin="round" strokeLinecap="round" />
                            <polyline points={pathPts} fill="none" stroke="white" strokeWidth="4" strokeDasharray="15,15" opacity="0.6" />
                            <line x1={goal.x} y1={goal.y-60} x2={goal.x} y2={goal.y+60} stroke="#fb7185" strokeWidth="8"/>
                            <text x={goal.x + 20} y={goal.y} fill="#fb7185" fontSize="24" fontWeight="bold" style={{textShadow: '2px 2px 0 #fff'}}>GOAL</text>
                            <text x={goal.x + 20} y={goal.y - 40} fill="#f472b6" fontSize="18" opacity="0.8" style={{textShadow: '2px 2px 0 #fff'}}>START</text>
                        </svg>
                        {horses.map(h => {
                            const p = progress.find(pr => pr.id === h.id); if(!p) return null;
                            const pos = heartPos(START_T + 2 * Math.PI * (p.dist / RACE_TOTAL_DISTANCE), h.id);
                            const pal = ['#fed7e2', '#fbb6ce', '#bfdbfe', '#a5b4fc', '#fde68a', '#bbf7d0', '#fed7aa', '#f9a8d4'];
                            return <div key={h.id} className="absolute flex flex-col items-center justify-center transition-transform duration-100 will-change-transform" style={{left:`${pos.x/10}%`, top:`${pos.y/5}%`, width:'4%', height:'10%', transform:'translate(-50%,-50%)', zIndex:Math.floor(p.dist)}}>
                                <div className={`text-2xl filter drop-shadow-md horse-gallop ${p.status==='tired'?'grayscale':''}`}>{h.avatar}</div>
                                <div className="text-[8px] text-pink-900 px-1 rounded-full whitespace-nowrap -mt-1 font-bold border border-pink-200 bg-white/90" style={{backgroundColor:pal[h.id%8]}}>{h.number}.{h.name}</div>
                            </div>
                        })}
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-24 text-pink-900">
                    <header className="bg-white/80 backdrop-blur sticky top-0 z-20 shadow-md border-b border-pink-200 px-3 py-2 flex justify-between items-center">
                        <div className="flex items-center gap-2" onClick={phase === 'racing' ? null : resetGame} style={{ cursor: phase === 'racing' ? 'not-allowed' : 'pointer', opacity: phase === 'racing' ? 0.5 : 1 }}>
                            <Trophy className="text-pink-400" size={24} />
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-pink-600 flex items-center gap-2">
                                    KIRA‚ú™„Éë„É¨„Éº„Éâ
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); if(phase !== 'racing') onOpenSwitch(); }} 
                                        className={`bg-pink-100 hover:bg-pink-200 p-1 rounded-full transition-colors ${phase === 'racing' ? 'opacity-50 cursor-not-allowed' : ''}`} 
                                        title="„É¢„Éº„ÉâÂàáÊõø"
                                    >üê¥</button>
                                </h1>
                                <span className="text-xs text-pink-300">PARADE {raceCount}</span>
                            </div>
                        </div>
                        <div className="relative group cursor-pointer" onMouseEnter={() => setShowHistory(true)} onMouseLeave={() => setShowHistory(false)}>
                            <div className={`flex items-center gap-2 px-3 py-1 rounded-full transition-colors ${wallet < 0 ? 'bg-rose-200 animate-pulse' : 'bg-pink-100'}`}>
                                <Coins className={wallet < 0 ? 'text-rose-500' : 'text-pink-400'} size={16} />
                                <span className={`font-mono font-bold text-lg ${wallet < 0 ? 'text-rose-500' : 'text-pink-600'}`}>{wallet.toLocaleString()}</span>
                                <span className="text-[11px] text-pink-400">„Ç∏„É•„Ç®„É´</span>
                            </div>
                            {showHistory && (
                                <div className="absolute right-0 top-full mt-2 w-64 bg-white border border-pink-200 rounded-2xl shadow-2xl p-3 z-50">
                                    <h4 className="text-xs text-pink-400 font-bold mb-2 flex items-center gap-1"><Info size={12} /> „Åç„Çâ„Åç„ÇâÂ±•Ê≠¥ (Áõ¥Ëøë10‰ª∂)</h4>
                                    <div className="max-h-60 overflow-y-auto history-scroll space-y-2">
                                        {resultLog.length === 0 ? <div className="text-xs text-pink-200 text-center py-4">Â±•Ê≠¥„Å™„Åó</div> : resultLog.slice(0, 10).map((log, i) => (
                                            <div key={i} className="bg-pink-50 p-2 rounded-xl text-xs border border-pink-100">
                                                <div className="flex justify-between mb-1">
                                                    <span className="text-pink-500 font-bold">P{log.race}</span>
                                                    <span className="truncate max-w-[120px] text-pink-400">{log.winner}</span>
                                                </div>
                                                <div className="flex justify-between items-end">
                                                    <span className="text-pink-300 text-[11px]">{log.betTotal} ‚Üí {log.payout}</span>
                                                    <span className={`font-bold ${log.payout-log.betTotal >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                        {log.payout-log.betTotal > 0 ? '+' : ''}{(log.payout-log.betTotal).toLocaleString()}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-2 pt-2 border-t border-pink-100 text-right text-xs">
                                        <div className="text-pink-300">Total Profit</div>
                                        <div className={`font-mono font-bold text-sm ${wallet - 100000 >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                            {wallet - 100000 > 0 ? '+' : ''}{(wallet - 100000).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto p-3 space-y-4">
                        {phase === 'betting' && (
                            <div className="bg-white rounded-3xl overflow-hidden shadow-xl border border-pink-100">
                                <div className="bg-gradient-to-r from-pink-300 to-purple-300 text-white p-2 font-bold text-center text-sm">„Åä„Å®„ÇÇ„Å†„Å°„É™„Çπ„Éà</div>
                                <div className="divide-y divide-pink-50">
                                    <div className="grid grid-cols-12 text-[11px] text-pink-300 bg-pink-50 p-2 font-bold text-center"><div className="col-span-1">No.</div><div className="col-span-3 text-left pl-2">„Åä„Å™„Åæ„Åà</div><div className="col-span-2">„Éë„Éº„Éà„Éä„Éº</div><div className="col-span-2">„Çπ„Çø„Ç§„É´</div><div className="col-span-2">„Ç≠„É©„Ç≠„É©‰ΩìÈáç</div><div className="col-span-2">„Åç„Çâ„Åç„ÇâÂÄçÁéá</div></div>
                                    {horses.map(h => (
                                        <div key={h.id} className="grid grid-cols-12 items-center p-2 text-xs hover:bg-pink-50 relative group" onMouseEnter={() => setHoveredHorse(h)} onMouseLeave={() => setHoveredHorse(null)}>
                                            <div className="col-span-1 flex justify-center"><span className="w-6 h-6 rounded-full flex items-center justify-center font-bold text-[11px] bg-pink-100 text-pink-600 border border-pink-200">{h.number}</span></div>
                                            <div className="col-span-3 pl-2 font-bold text-pink-700 truncate">{h.name}</div>
                                            <div className="col-span-2 text-center text-[11px] text-pink-400 truncate">{h.jockey} <span className="text-[9px] bg-pink-100 px-1 rounded-full border border-pink-200">{h.jockeyRank}</span></div>
                                            <div className="col-span-2 text-center text-[11px] text-pink-500"><span className="px-1 bg-pink-50 rounded-full border border-pink-100">{h.style.label}</span></div>
                                            <div className="col-span-2 text-center text-[11px]">{h.weight}kg <span className={h.weightDiff>0?'text-rose-500':h.weightDiff<0?'text-sky-500':'text-pink-200'}>({h.weightDiff>0?'+':''}{h.weightDiff})</span></div>
                                            <div className="col-span-2 text-right font-mono font-bold text-rose-500 pr-2">{h.odds}</div>
                                        </div>
                                    ))}
                                </div>
                                {hoveredHorse && (
                                    <div 
                                        className="fixed z-50 bg-white/95 text-pink-900 p-3 rounded-2xl shadow-2xl text-[11px] pointer-events-none w-52 border border-pink-200 backdrop-blur-sm animate-in fade-in zoom-in-95 duration-100"
                                        style={{ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}
                                    >
                                        <div className="font-bold text-pink-500 text-sm mb-2 border-b border-pink-100 pb-1">{hoveredHorse.name}</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <div className="text-pink-300">ÂâçÂõû„ÅÆ„Ç≠„É©„Ç≠„É©È†Ü‰Ωç</div>
                                                <div className="font-bold text-lg">{hoveredHorse.prevRank}Áï™„ÇÅ</div>
                                            </div>
                                            <div>
                                                <div className="text-pink-300">ÂâçÂõû„ÅÆ‰ΩìÈáç</div>
                                                <div className="font-bold">{hoveredHorse.weight - hoveredHorse.weightDiff}kg</div>
                                            </div>
                                            <div className="col-span-2 mt-1">
                                                <div className="text-pink-300">„Åî„Åç„Åí„Çì</div>
                                                <div className={`font-bold ${hoveredHorse.condition > 0.2 ? 'text-rose-400' : hoveredHorse.condition < -0.1 ? 'text-sky-400' : 'text-emerald-400'}`}>
                                                    {hoveredHorse.condition > 0.2 ? 'Ë∂Ö„Éè„ÉÉ„Éî„ÉºÔºÅ' : hoveredHorse.condition > 0 ? '„ÅÑ„ÅÑ„Åã„Çì„Åò' : hoveredHorse.condition > -0.1 ? '„Åµ„Å§„ÅÜ„Å†„Çà' : '„Å°„Çá„Å£„Å®„Å≠„ÇÄ„ÅÑ‚Ä¶'}
                                                    {hoveredHorse.weightDiff > 6 && <span className="ml-2 text-[9px] bg-rose-500 text-white px-1 rounded-full">„ÅΩ„Å£„Å°„ÇÉ„Çä</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="p-4 bg-pink-50">
                                    <div className="block md:hidden bg-pink-50 border-b border-pink-100 p-2 mb-4">
                                        <select 
                                            className="w-full p-3 bg-white border border-pink-200 rounded-xl font-bold text-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm"
                                            value={betType}
                                            onChange={(e) => handleBetTypeChange(e.target.value)}
                                        >
                                            {Object.values(BET_TYPES).map(type => (
                                                <option key={type.id} value={type.id}>
                                                    {type.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="hidden md:flex bg-pink-50 border-b border-pink-100 mb-4 flex-wrap">
                                        {Object.values(BET_TYPES).map(t => <button key={t.id} onClick={() => { setBetType(t.id); setSelectedHorses([null,null,null]); }} className={`flex-1 py-3 text-[11px] font-bold min-w-[80px] ${betType===t.id?'bg-pink-400 text-white shadow-inner':'text-pink-400 hover:bg-pink-100'}`}>{t.name}</button>)}
                                    </div>

                                    <div className="bg-pink-100 text-pink-600 text-xs p-2 rounded-xl mb-4 border border-pink-200 flex items-center gap-2">
                                        <Info size={16} />
                                        <span>{BET_TYPES[betType].desc}</span>
                                    </div>

                                    <div className="mb-4 space-y-2">
                                        {[...Array(BET_TYPES[betType].count)].map((_, i) => (
                                            <div key={i} className="flex items-center gap-2"><span className="w-20 font-bold text-pink-700 text-xs">{i===0?'1„Å¥„Åç„ÇÅ':i===1?'2„Å≤„Åç„ÇÅ':'3„Å≥„Åç„ÇÅ'}</span>
                                                <select className="flex-1 p-2 bg-white border border-pink-200 rounded text-sm text-pink-600" value={selectedHorses[i]??''} onChange={e=> {const n=[...selectedHorses]; n[i]=e.target.value===''?null:parseInt(e.target.value); setSelectedHorses(n);}}>
                                                    <option value="">„Åà„Çâ„Çì„Åß„Å≠‚Ä¶</option>{horses.map((h, idx) => <option key={h.id} value={idx} disabled={selectedHorses.includes(idx) && selectedHorses[i]!==idx}>{h.number}.{h.name} ({h.odds})</option>)}
                                                </select>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center bg-white p-3 rounded-2xl border border-pink-100">
                                        <div className="text-3xl font-bold font-mono text-rose-500">{calculateComboOdds(betType, selectedHorses.slice(0, BET_TYPES[betType].count).map(i=>i!==null?horses[i]?.id:undefined), horses) || "---"} <span className="text-sm text-pink-300">ÂÄç</span></div>
                                        <div className="flex items-center gap-2"><input type="number" step="100" className="w-24 p-1 border border-pink-200 rounded-lg text-right font-bold text-pink-700" value={betAmount} onChange={e=>setBetAmount(e.target.value)} /><button onClick={addToSlip} className="bg-gradient-to-r from-rose-400 to-pink-400 text-white font-bold py-2 px-6 rounded-full text-xs shadow">+„ÇÜ„ÇÅ„ÉÅ„Ç±„Å´„Åô„Çã</button></div>
                                    </div>
                                </div>

                                {betSlip.length > 0 && (
                                    <div className="bg-pink-100 p-4">
                                        <h3 className="text-xs font-bold text-pink-500 mb-3 flex items-center gap-2">
                                            <Ticket size={16} /> „Åç„Åø„ÅÆ„ÇÜ„ÇÅ„ÉÅ„Ç±
                                        </h3>
                                        <div className="space-y-2 mb-4">
                                            {betSlip.map(b => (
                                                <BettingTicket key={b.id} bet={b} onDelete={(id) => setBetSlip(betSlip.filter(x=>x.id!==id))} isResult={false} />
                                            ))}
                                        </div>
                                        <div className="flex justify-between items-center pt-2 border-t border-pink-200 text-pink-700">
                                            <span className="text-sm font-bold">„Åú„Çì„Å∂„Åß: {betSlip.reduce((s,b)=>s+b.amount,0).toLocaleString()}„Ç∏„É•„Ç®„É´</span>
                                            <button onClick={startRace} className="bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-3 px-8 rounded-full shadow-lg text-sm animate-pulse">„Éë„É¨„Éº„Éâ„Çí„ÅØ„Åò„ÇÅ„Çã</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {showTipster && phase === 'betting' && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden border-4 border-pink-300">
                                    <div className="bg-gradient-to-r from-pink-400 to-purple-400 text-white p-4 flex justify-between font-bold"><span>„ÇÜ„ÇÅ‰∫àÊÉ≥„É´„Éº„É†</span><button onClick={()=>setShowTipster(false)}>&times;</button></div>
                                    <div className="p-6 space-y-4">
                                        <div><label className="text-sm font-bold text-purple-700">„Åç„Çâ„Åç„Çâ‰∫àÁÆó</label><input type="number" className="w-full p-2 border border-pink-200 rounded" value={tipsterBudget} onChange={e=>setTipsterBudget(e.target.value)} /></div>
                                        <div className="space-y-2">{Object.values(TIPSTER_COURSES).map(c=><div key={c.id} onClick={()=>setTipsterCourse(c.id)} className={`p-3 border rounded-lg cursor-pointer text-xs ${tipsterCourse===c.id?'border-pink-400 bg-pink-50':''}`}><div className="font-bold text-pink-600">{c.name}</div><div className="text-pink-400">{c.desc}</div></div>)}</div>
                                        <button onClick={purchaseTipster} className="w-full bg-gradient-to-r from-pink-400 to-purple-400 text-white font-bold py-3 rounded-xl shadow-lg">„ÇÜ„ÇÅ‰∫àÊÉ≥„Çí„ÇÇ„Çâ„ÅÜ üíñ</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {phase === 'betting' && <button onClick={()=>setShowTipster(true)} className="fixed bottom-6 right-6 bg-gradient-to-br from-pink-400 to-purple-400 text-white p-4 rounded-full shadow-2xl border-4 border-white animate-bounce z-40 text-3xl">üîÆ</button>}

                        {phase === 'fanfare' && <div className="h-64 flex flex-col items-center justify-center bg-pink-100 rounded-3xl border-4 border-pink-300 shadow-xl"><div className="text-6xl mb-4 animate-bounce">üé∫</div><h2 className="text-3xl font-black text-pink-600 tracking-widest drop-shadow">YUME FANFARE</h2></div>}

                        {phase === 'racing' && (
                            <div className="space-y-4">
                                <div className="bg-pink-500 text-white font-bold text-center py-2 rounded-3xl border border-pink-300 text-sm tracking-wider shadow">{commentary}</div>
                                <HeartTrack horses={horses} progress={raceProgress} />
                                <div className="bg-purple-900/80 text-white p-3 rounded-3xl backdrop-blur border-4 border-pink-300 overflow-x-auto flex gap-2"><span className="bg-red-500 px-2 rounded font-bold whitespace-nowrap text-xs flex items-center shadow">ÂÖàÈ†≠</span>{raceRanking.map((h,i)=><div key={h.id} className={`flex items-center gap-1 px-2 py-1 rounded-full shrink-0 border text-[11px] ${h.rank?'bg-yellow-400 text-white border-yellow-200':'bg-white/20 text-pink-100 border-pink-200/30'}`}><span className="font-bold text-white">{h.rank?h.rank+'Áï™„ÇÅ':i+1}</span><span className="w-4 h-4 rounded-full text-[9px] flex items-center justify-center bg-white text-purple-900 font-bold">{h.number}</span><span>{h.name}</span></div>)}</div>

                                {betSlip.length > 0 && (
                                    <div className="mt-4">
                                        <h3 className="text-pink-600 font-bold mb-2 flex items-center gap-2 text-xs px-2">
                                            <Ticket size={16} /> „ÇÇ„Å£„Å¶„ÅÑ„Çã„ÇÜ„ÇÅ„ÉÅ„Ç±
                                        </h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 px-2">
                                            {betSlip.map(bet => (
                                                <BettingTicket key={bet.id} bet={bet} onDelete={() => {}} isResult={false} hit={null} readOnly={true} />
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {phase === 'result' && finalResult && (
                            <div className="bg-white text-pink-900 rounded-3xl shadow-2xl border-4 border-pink-300 overflow-hidden">
                                <div className="bg-gradient-to-r from-pink-300 to-purple-300 p-4 text-center"><h2 className="text-2xl font-black text-white drop-shadow">RESULT</h2></div>
                                <div className="p-4">
                                    <div className="bg-pink-50 rounded-2xl p-3 mb-6 border border-pink-100">
                                        <div className="grid grid-cols-12 text-xs text-pink-400 font-bold border-b border-pink-200 pb-2 mb-2">
                                            <div className="col-span-2 text-center">È†Ü‰Ωç</div>
                                            <div className="col-span-5 pl-1">„Åä„Å®„ÇÇ„Å†„Å°</div>
                                            <div className="col-span-2 text-center">„Çπ„Çø„Ç§„É´</div>
                                            <div className="col-span-3 text-right pr-2">ÂÄçÁéá</div>
                                        </div>
                                        <div className="space-y-2">
                                            {finalResult.map((h, i) => (
                                                <div key={h.id} className={`grid grid-cols-12 items-center text-sm p-1 rounded-xl ${i===0 ? 'bg-yellow-100 font-bold' : i===1?'bg-gray-100':i===2?'bg-orange-50':''}`}>
                                                    <div className="col-span-2 text-center">
                                                        <span className={`inline-block w-6 h-6 rounded-full leading-6 text-xs ${i===0?'bg-yellow-400 text-white':i===1?'bg-gray-400 text-white':i===2?'bg-orange-400 text-white':'text-gray-400'}`} style={{ backgroundColor: ['white','black','#e53935','#1e88e5','#fdd835','#43a047','#fb8c00','#f48fb1'][i%8], color: [0,4,7].includes(i%8)?'black':'white', border: i===0?'1px solid #ccc':'none' }}>{i+1}</span>
                                                    </div>
                                                    <div className="col-span-5 flex items-center gap-1 pl-1">
                                                        <span className={`w-4 h-4 rounded text-[10px] flex items-center justify-center bg-pink-200 text-pink-700 font-bold`}>{h.number}</span>
                                                        <span className="truncate text-xs">{h.name}</span>
                                                    </div>
                                                    <div className="col-span-2 text-center text-xs text-pink-400">{h.style.label}</div>
                                                    <div className="col-span-3 text-right font-mono text-rose-500 pr-2 text-xs">{h.odds}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {betSlip.length > 0 && (
                                        <div className="mb-6">
                                            <h3 className="font-bold text-pink-500 mb-2 flex items-center gap-2 text-xs">
                                                <Ticket size={16} /> „ÅÇ„Å™„Åü„ÅÆ„ÇÜ„ÇÅ„ÉÅ„Ç±ÁµêÊûú
                                            </h3>
                                            <div className="space-y-2">
                                                {betSlip.map(bet => (
                                                    <BettingTicket 
                                                        key={bet.id} 
                                                        bet={bet} 
                                                        isResult={true}
                                                        hit={checkWin(bet, finalResult)}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="text-center border-t border-pink-100 pt-4">
                                        <div className="text-pink-300 mb-1 text-xs">‰ªäÂõû„Åµ„Åà„Åü„Ç∏„É•„Ç®„É´</div>
                                        <div className={`text-4xl font-black font-mono ${(resultLog[0]?.payout-resultLog[0]?.betTotal)>=0?'text-emerald-500':'text-rose-500'}`}>{((resultLog[0]?.payout-resultLog[0]?.betTotal)>=0?'+':'') + (resultLog[0]?.payout-resultLog[0]?.betTotal).toLocaleString()}</div>
                                        <div className="text-[10px] sm:text-xs text-pink-300 font-bold mt-1">
                                            (ÊâïÊàªÔºö{resultLog[0]?.payout.toLocaleString()}„ÄÅ„ÇÜ„ÇÅ„ÉÅ„Ç±Ë≥ºÂÖ•Ôºö-{resultLog[0]?.betTotal.toLocaleString()})
                                        </div>
                                        <button onClick={() => { setRaceCount(c=>c+1); }} className="mt-6 bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-3 px-12 rounded-full shadow-lg hover:from-pink-600 hover:to-purple-600 transition-transform hover:scale-105 flex items-center justify-center gap-2 mx-auto text-sm"><RotateCcw size={18} /> „Å§„Åé„ÅÆ„Åç„Çâ„Åç„Çâ„Éë„É¨„Éº„Éâ„Å∏</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };


        // ============================================================================================
        //  APP ROOT (GAME LAUNCHER)
        // ============================================================================================
        const GameLauncher = () => {
            // ‚òÖ‰øÆÊ≠£: localStorageË™≠„ÅøËæº„ÅøÊôÇ„Å´Êï∞ÂÄ§„ÉÅ„Çß„ÉÉ„ÇØ„ÇíË°å„ÅÜÔºàNaNÂõûÈÅøÔºâ
            const [wallet, setWallet] = useState(() => {
                const val = parseFloat(localStorage.getItem('g1dream_wallet'));
                return Number.isFinite(val) ? val : 100000;
            });
            const [raceCount, setRaceCount] = useState(() => {
                const val = parseInt(localStorage.getItem('g1dream_raceCount'));
                return Number.isFinite(val) ? val : 1;
            });
            const [resultLog, setResultLog] = useState(() => {
                try {
                    const saved = localStorage.getItem('g1dream_resultLog');
                    return saved ? JSON.parse(saved) : [];
                } catch(e) { return []; }
            });
            
            const [mode, setMode] = useState(() => localStorage.getItem('g1dream_mode') || 'normal');
            const [isSwitchModalOpen, setIsSwitchModalOpen] = useState(false);

            useEffect(() => {
                localStorage.setItem('g1dream_wallet', wallet);
                localStorage.setItem('g1dream_raceCount', raceCount);
                localStorage.setItem('g1dream_resultLog', JSON.stringify(resultLog));
                localStorage.setItem('g1dream_mode', mode);
            }, [wallet, raceCount, resultLog, mode]);

            useEffect(() => {
                if (mode === 'normal') {
                    document.body.className = 'mode-normal-body';
                } else {
                    document.body.className = 'mode-kirakira-body';
                }
            }, [mode]);

            const switchMode = (newMode) => {
                setMode(newMode);
                setIsSwitchModalOpen(false);
            };

            const resetData = () => {
                if(confirm("ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")) {
                    setWallet(100000);
                    setRaceCount(1);
                    setResultLog([]);
                }
            }

            return (
                <>
                    {/* Mode Switcher Modal */}
                    {isSwitchModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in zoom-in-95 duration-200">
                            <div className="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-md w-full">
                                <div className="p-6 text-center">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center justify-center gap-2">
                                        <SwitchIcon className="text-blue-500"/> „É¢„Éº„ÉâÈÅ∏Êäû
                                    </h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button 
                                            onClick={() => switchMode('normal')}
                                            className={`p-4 rounded-xl border-4 transition-all hover:scale-105 ${mode === 'normal' ? 'border-green-600 bg-green-50 ring-2 ring-green-300' : 'border-gray-200 bg-white hover:bg-gray-50'}`}
                                        >
                                            <div className="text-4xl mb-2">üê¥</div>
                                            <div className="font-bold text-green-800">Êú¨Ê†º„É¢„Éº„Éâ</div>
                                            <div className="text-xs text-gray-500 mt-1">„É™„Ç¢„É´„Å™Á´∂È¶¨‰ΩìÈ®ì</div>
                                        </button>
                                        <button 
                                            onClick={() => switchMode('kirakira')}
                                            className={`p-4 rounded-xl border-4 transition-all hover:scale-105 ${mode === 'kirakira' ? 'border-pink-400 bg-pink-50 ring-2 ring-pink-300' : 'border-gray-200 bg-white hover:bg-gray-50'}`}
                                        >
                                            <div className="text-4xl mb-2">ü¶Ñ</div>
                                            <div className="font-bold text-pink-600">„Ç≠„É©„Ç≠„É©„É¢„Éº„Éâ</div>
                                            <div className="text-xs text-gray-500 mt-1">„ÇÜ„ÇÅ„Åã„Çè„Éë„É¨„Éº„Éâ</div>
                                        </button>
                                    </div>
                                    <div className="mt-6 flex justify-between items-center border-t pt-4">
                                        <button onClick={resetData} className="text-xs text-gray-400 hover:text-red-500 underline">„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</button>
                                        <button onClick={() => setIsSwitchModalOpen(false)} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-full font-bold text-gray-600">„Å®„Åò„Çã</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Active Game Component */}
                    {mode === 'normal' ? (
                        <NormalMode 
                            wallet={wallet} setWallet={setWallet}
                            raceCount={raceCount} setRaceCount={setRaceCount}
                            resultLog={resultLog} setResultLog={setResultLog}
                            onOpenSwitch={() => setIsSwitchModalOpen(true)}
                        />
                    ) : (
                        <KirakiraMode 
                            wallet={wallet} setWallet={setWallet}
                            raceCount={raceCount} setRaceCount={setRaceCount}
                            resultLog={resultLog} setResultLog={setResultLog}
                            onOpenSwitch={() => setIsSwitchModalOpen(true)}
                        />
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameLauncher />);
    </script>
</body>
</html>